# é¡¹ç›®ä»‹ç»

è¿™æ˜¯ä¸€ä¸ªåŸºäºä¸»ä»Reactoræ¨¡å‹çš„é«˜å¹¶å‘æœåŠ¡å™¨ï¼Œä¸»reactorè´Ÿè´£æ¥å—æ–°è¿æ¥ï¼Œä»reactorè´Ÿè´£å¤„ç†IOè¯·æ±‚å’Œä¸šåŠ¡é€»è¾‘ï¼Œé‡‡ç”¨epollå®ç°IOå¤šè·¯å¤ç”¨ï¼Œæ”¯æŒå®šæ—¶å™¨ç®¡ç†è¿æ¥è¶…æ—¶ï¼ŒHTTPåè®®çš„è§£æä¸å“åº”



ğŸŒŸå®¢æˆ·ç«¯ä»å‘é€è¯·æ±‚å¾—åˆ°å“åº”çš„è¿‡ç¨‹

- é“¾æ¥å»ºç«‹é˜¶æ®µ

å®¢æˆ·ç«¯å‘èµ·è¿æ¥è¯·æ±‚â€”â€”ä¸»Reactor(baseloop)é€šè¿‡epollç›‘å¬é“¾æ¥å»ºç«‹äº‹ä»¶ï¼ˆepollåˆ¤æ–­ç›‘å¬socketçš„å…¨é“¾æ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼‰â€”â€”åˆ›å»ºConnectionå¯¹è±¡ï¼ˆåŒ…å«fdã€bufferã€httpå±‚è®¾ç½®çš„å›è°ƒï¼‰ï¼Œå¹¶é€šè¿‡è½®è¯¢çš„æ–¹å¼åˆ†é…ç»™ä¸€ä¸ªä»Reactor(subloop)å¤„ç†

- è¯·æ±‚å¤„ç†é˜¶æ®µï¼š

ä»Reactorç›‘å¬åˆ°å¯è¯»äº‹ä»¶ï¼ŒConnectionè°ƒç”¨handleReadæ¥æ”¶æ•°æ®â€”â€”æ•°æ®å…ˆå­˜å…¥Connectionçš„è¾“å…¥ç¼“å†²åŒº(*in_buffer)*â€”â€”HttpContextè§£æHTTPè¯·æ±‚ï¼ˆConnectionæ”¶åˆ°æ•°æ®åä¼šç›´æ¥è°ƒç”¨message_callbackæ¥é€šçŸ¥ä¸Šå±‚ï¼‰

- æ ¹æ®è¯·æ±‚ç±»å‹è¿›è¡Œå¤„ç†ï¼š

é™æ€èµ„æºè¯·æ±‚ï¼šç›´æ¥è¯»å–æ–‡ä»¶å†…å®¹

åŠ¨æ€è¯·æ±‚ï¼šè°ƒç”¨å¯¹åº”çš„è·¯ç”±å¤„ç†å‡½æ•°

- å¯åŠ¨å†™äº‹ä»¶ç›‘æ§ï¼ˆè°ƒç”¨channelå¯¹è±¡çš„enableWriteï¼Œå°†äº‹ä»¶æ ‡è®°ä¸ºå¯å†™EPOLLOUTå¹¶æ›´æ–°åˆ°epollå½“ä¸­ï¼Œéšååœ¨ä¸‹ä¸€è½®epoll_waitåè°ƒç”¨handleWriteå†™æ•°æ®ï¼‰

å°†å“åº”æ•°æ®å†™å…¥è¾“å‡ºç¼“å†²åŒº(*out_buffer)*â€”â€”Connectionçš„handleWriteå°†æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯

å¦‚æœæ˜¯çŸ­è¿æ¥åˆ™å…³é—­è¿æ¥ï¼Œé•¿è¿æ¥åˆ™ä¿æŒç­‰å¾…ä¸‹ä¸€æ¬¡è¯·æ±‚

# ç›¸å…³é—®é¢˜

## ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡

1. ä¸ä¼ ç»Ÿå•çº¿ç¨‹epollç›¸æ¯”ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸cpuèµ„æºï¼Œæå‡å¹¶å‘
2. ä¸å¤šä¸ªçº¿ç¨‹åŒæ—¶ç›‘å¬ä¸€ä¸ªepollå®ä¾‹ç›¸æ¯”ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ªepollï¼Œé¿å…äº†æƒŠç¾¤æ•ˆåº”ï¼Œæœ€å¤§é™åº¦çš„åˆ©ç”¨æ“ä½œç³»ç»Ÿèµ„æº



## ä»€ä¹ˆæ˜¯Reactor/Proactor

ä¸¤è€…éƒ½æ˜¯å¤„ç†IOäº‹ä»¶çš„å¹¶å‘æ¨¡å¼

- Reactor

åŒæ­¥éé˜»å¡IOï¼Œ é€šè¿‡IOå¤šè·¯å¤ç”¨ç­‰å¾…äº‹ä»¶å°±ç»ªï¼ŒReactoræ£€æµ‹åˆ°å°±ç»ªäº‹ä»¶ï¼Œè°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°é€šè¿‡read/writeè¿›è¡Œæ•°æ®è¯»å†™ï¼Œå¤„ç†å®Œä¹‹åç»§ç»­ç›‘å¬æ–°äº‹ä»¶åˆ°æ¥

- Proactor

å¼‚æ­¥IOï¼Œç¨‹åºæå‰æäº¤IOè¯·æ±‚ï¼Œæ“ä½œç³»ç»Ÿåå°å®ŒæˆIOæ“ä½œï¼ŒProactoræ”¶åˆ°å®Œæˆé€šçŸ¥ï¼Œè°ƒç”¨å›è°ƒå‡½æ•°æ‰§è¡Œä¸šåŠ¡ä»£ç å¤„ç†IOç»“æœ

## epollä¸­ETå’ŒLTçš„åŒºåˆ«? ä½¿ç”¨åœºæ™¯ï¼Ÿ

- ETï¼šäº‹ä»¶åªåœ¨çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘ï¼Œå¦‚æœæ²¡æœ‰å¤„ç†å®Œæ•°æ®ï¼Œå†æ¬¡è°ƒç”¨ epoll_wait æ—¶ï¼Œä¸ä¼šå†æ¬¡é€šçŸ¥ï¼Œéœ€è¦**ä¸€æ¬¡æ€§å¤„ç†å®Œæ‰€æœ‰æ•°æ®**ã€‚
  - å¯¹äºéé˜»å¡å¥—æ¥å­—ä½¿ç”¨æ—¶æ€§èƒ½æ›´é«˜ï¼Œå› ä¸ºå‡å°‘äº†å†…æ ¸ä¸ç”¨æˆ·ç©ºé—´é¢‘ç¹äº¤äº’ã€‚
  - **é€‚ç”¨åœºæ™¯**ï¼šé«˜å¹¶å‘ã€é«˜æ€§èƒ½çš„åœºæ™¯ï¼Œä¾‹å¦‚é«˜æ€§èƒ½ Web æœåŠ¡å™¨ï¼ˆå¦‚ Nginxï¼‰ã€‚æ•°æ®æµé‡å¤§ä¸” I/O æ“ä½œé¢‘ç¹çš„æƒ…å†µã€‚
- LTï¼šäº‹ä»¶ä¼šæŒç»­è§¦å‘ï¼Œåªè¦æ–‡ä»¶æè¿°ç¬¦å¤„äºå¯è¯»æˆ–å¯å†™çŠ¶æ€ï¼Œå°±ä¼šåå¤é€šçŸ¥ï¼Œç›´åˆ°çŠ¶æ€æ”¹å˜ã€‚
  - **é€‚ç”¨åœºæ™¯**ï¼šé€‚åˆå¤„ç†å°‘é‡ I/O æˆ–å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„ç¨‹åºã€‚



## epoll çš„æƒŠç¾¤æ•ˆåº”åº”è¯¥æ€æ ·é¿å…ï¼Ÿ

**1ï¸âƒ£ä»€ä¹ˆæ˜¯æƒŠç¾¤æ•ˆåº”**ï¼šå½“ä¸€ä¸ªäº‹ä»¶è§¦å‘æ—¶ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹éƒ½åœ¨ç­‰å¾…åŒä¸€ä¸ª epoll å®ä¾‹ï¼Œå®ƒä»¬éƒ½ä¼šè¢«å†…æ ¸å”¤é†’ã€‚ä½†åªæœ‰ä¸€ä¸ªçº¿ç¨‹/è¿›ç¨‹å¯ä»¥æˆåŠŸå¤„ç†äº‹ä»¶ï¼Œå…¶ä½™çº¿ç¨‹/è¿›ç¨‹ä¼šæ— åŠŸè€Œè¿”ï¼Œæµªè´¹äº†ç³»ç»Ÿèµ„æºã€‚



**2ï¸âƒ£å¦‚ä½•é¿å…**ï¼š

**æ–¹æ³• 1ï¼šä½¿ç”¨ EPOLLONESHOT**

`EPOLLONESHOT` æ˜¯ epoll æä¾›çš„ä¸€ç§é€‰é¡¹ï¼Œå½“ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶è¢«è§¦å‘å¹¶ä¸”ä¸€ä¸ªçº¿ç¨‹æˆåŠŸå¤„ç†äº†è¯¥äº‹ä»¶åï¼Œ**å†…æ ¸ä¼šæš‚æ—¶å°†è¯¥æ–‡ä»¶æè¿°ç¬¦ä» epoll äº‹ä»¶é›†åˆä¸­ç§»é™¤**ã€‚åªæœ‰å½“å‰çº¿ç¨‹/è¿›ç¨‹å¤„ç†å®Œäº‹ä»¶åï¼Œé‡æ–°å°†è¯¥æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ° epoll ä¸­ï¼Œæ‰èƒ½å†æ¬¡è§¦å‘äº‹ä»¶ã€‚

**ä»£ç ç¤ºä¾‹**ï¼š

```cpp
struct epoll_event event;
event.events = EPOLLIN | EPOLLONESHOT; // æ³¨å†Œ EPOLLONESHOT
event.data.fd = sock_fd;
epoll_ctl(epoll_fd, EPOLL_CTL_ADD, sock_fd, &event);

// åœ¨äº‹ä»¶å¤„ç†å®Œä¹‹åï¼Œé‡æ–°æ·»åŠ æ–‡ä»¶æè¿°ç¬¦
event.events = EPOLLIN | EPOLLONESHOT;
epoll_ctl(epoll_fd, EPOLL_CTL_MOD, sock_fd, &event);
```

**æ–¹æ³• 2ï¼šç‹¬ç«‹çš„ epoll å®ä¾‹**

æ¯ä¸ªå­è¿›ç¨‹ç»´æŠ¤è‡ªå·±çš„ epoll å®ä¾‹ï¼Œé¿å…å¤šä¸ªè¿›ç¨‹ç›‘å¬åŒä¸€ä¸ª epollã€‚





## I/Oå¤šè·¯å¤ç”¨

- **selectï¼š** é€šè¿‡ **éå†+ä½å›¾** æ–¹å¼æ£€æŸ¥æ‰€æœ‰ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰

  - ç”¨æˆ·è¿›ç¨‹è°ƒç”¨ select(fd_set, timeout)ï¼Œå°†æ‰€æœ‰è¦ç›‘å¬çš„ fd ä¼ ç»™å†…æ ¸

  - å†…æ ¸ **éå†** è¿™äº› fdï¼Œå¹¶æŸ¥è¯¢å…¶çŠ¶æ€

  - ç”¨æˆ·è¿›ç¨‹è·å–è¿”å›çš„ fdï¼Œæ‰‹åŠ¨éå† **æ‰¾å‡ºå¯ç”¨çš„ fd** è¿›è¡Œå¤„ç†ã€‚

    ```c 
    fd_set rfds;
    FD_ZERO(&rfds);
    FD_SET(sockfd, &rfds);
    
    struct timeval timeout = {5, 0};  // è¶…æ—¶æ—¶é—´ 5 ç§’
    int ret = select(sockfd + 1, &rfds, NULL, NULL, &timeout);
    if (ret > 0 && FD_ISSET(sockfd, &rfds)) {
        // sockfd å¯è¯»ï¼Œè¿›è¡Œ read()
    }
    ```

- **poll**ï¼špoll é€šè¿‡ **æ•°ç»„** æ–¹å¼å­˜å‚¨ fdï¼Œé¿å…äº† select çš„ fd é™åˆ¶ï¼Œä½†ä»ç„¶é‡‡ç”¨ **éå†** æ–¹å¼æ£€æŸ¥ fd çŠ¶æ€ï¼Œæ€§èƒ½ä»æ˜¯ **O(n)**ã€‚

  ```c
  struct pollfd fds[1];
  fds[0].fd = sockfd;
  fds[0].events = POLLIN;  // ç›‘å¬å¯è¯»äº‹ä»¶
  
  int ret = poll(fds, 1, 5000);  // è¶…æ—¶ 5000ms
  if (ret > 0 && (fds[0].revents & POLLIN)) {
      // sockfd å¯è¯»ï¼Œè¿›è¡Œ read()
  }
  ```

- **epollï¼š**ä½¿ç”¨ **äº‹ä»¶é©±åŠ¨ï¼ˆEvent-Drivenï¼‰** çš„æ–¹å¼æ¥ç®¡ç†å¤§é‡æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰

  - è°ƒç”¨ epoll_create() åˆ›å»º epoll å®ä¾‹ï¼Œè¿”å› epoll_fdï¼›
  - è°ƒç”¨ epoll_ctl() **æ³¨å†Œï¼ˆEPOLL_CTL_ADDï¼‰** éœ€è¦ç›‘å¬çš„ fd åŠå…¶äº‹ä»¶ï¼ˆå¦‚ EPOLLINã€EPOLLOUTï¼‰ï¼›
  - è°ƒç”¨ epoll_wait()ï¼Œ**é˜»å¡ç­‰å¾…äº‹ä»¶å‘ç”Ÿ**ï¼Œè¿”å› **å‘ç”Ÿäº‹ä»¶çš„ fd**ï¼›

## io_uringæ˜¯ä»€ä¹ˆ

io_uring æ˜¯ Linux å†…æ ¸ **é«˜æ€§èƒ½å¼‚æ­¥ I/Oï¼ˆAsync I/Oï¼‰** æœºåˆ¶

âœ… **åŸºäºç¯å½¢ç¼“å†²åŒºï¼ˆRing Bufferï¼‰ï¼Œç”¨æˆ·æ€ä¸å†…æ ¸å…±äº«**ï¼ˆå‡å°‘ syscall å¼€é”€ï¼‰

âœ… **æ”¯æŒæ‰¹é‡æäº¤/è·å– I/O è¯·æ±‚**ï¼ˆé¿å… syscall é€ä¸ªè°ƒç”¨ï¼‰

io_uring ç”± **ä¸¤ä¸ªç¯å½¢ç¼“å†²åŒºï¼ˆRing Bufferï¼‰** ç»„æˆï¼š

1ï¸âƒ£ **æäº¤é˜Ÿåˆ—ï¼ˆSQ, Submission Queueï¼‰**ï¼šç”¨æˆ·æ€æäº¤ I/O è¯·æ±‚

2ï¸âƒ£ **å®Œæˆé˜Ÿåˆ—ï¼ˆCQ, Completion Queueï¼‰**ï¼šå†…æ ¸å®Œæˆ I/O åé€šçŸ¥ç”¨æˆ·æ€



```c
#include <liburing.h>
#include <fcntl.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

#define BUFFER_SIZE 4096

int main() {
    struct io_uring ring;
    io_uring_queue_init(8, &ring, 0);  // åˆå§‹åŒ– io_uringï¼Œé˜Ÿåˆ—å¤§å° 8

    int fd = open("test.txt", O_RDONLY);
    if (fd < 0) {
        perror("open failed");
        return 1;
    }

    struct io_uring_sqe *sqe = io_uring_get_sqe(&ring);  // è·å–æäº¤é˜Ÿåˆ—å…ƒç´ ï¼ˆSQEï¼‰
    char buffer[BUFFER_SIZE] = {0};
    struct iovec iov = { .iov_base = buffer, .iov_len = BUFFER_SIZE };
    
    io_uring_prep_readv(sqe, fd, &iov, 1, 0);  // å‡†å¤‡å¼‚æ­¥è¯»è¯·æ±‚
    io_uring_submit(&ring);  // æäº¤è¯·æ±‚åˆ°å†…æ ¸
    
    struct io_uring_cqe *cqe;
    io_uring_wait_cqe(&ring, &cqe);  // ç­‰å¾…å®Œæˆé˜Ÿåˆ—ï¼ˆCQEï¼‰
    printf("Read %d bytes: %s\n", cqe->res, buffer);

    io_uring_cqe_seen(&ring, cqe);  // æ ‡è®° CQE å·²å¤„ç†
    io_uring_queue_exit(&ring);
    close(fd);
    return 0;
}
```



## å‹åŠ›æµ‹è¯•å·¥å…·

ä½¿ç”¨wrk

```bash
# ä½¿ç”¨12ä¸ªçº¿ç¨‹è¿è¡Œ30ç§’ï¼Œä¿æŒ400ä¸ªHTTPè¿æ¥
wrk -t12 -c400 -d30s http://localhost:8080/

# é‡è¦å‚æ•°è¯´æ˜ï¼š
# -t: çº¿ç¨‹æ•°
# -c: å¹¶å‘è¿æ¥æ•°
# -d: æµ‹è¯•æ—¶é—´
# -s: æŒ‡å®šLuaè„šæœ¬
```

### [æ€§èƒ½æŒ‡æ ‡](https://mikechen.cc/15729.html)

- QPS

- TPSï¼š

  > QPSå’ŒTPSçš„åŒºåˆ«ï¼š
  >
  > **ä¸€ä¸ªäº‹åŠ¡å¯èƒ½åŒ…å«å¤šä¸ªæŸ¥è¯¢**

- RTå“åº”æ—¶é—´

- å¹¶å‘æ•°





## å½±å“æœåŠ¡å™¨é“¾æ¥æ•°çš„å› ç´ 

**1ï¸âƒ£ æ–‡ä»¶æè¿°ç¬¦æ•°é‡é™åˆ¶**

- æ®µé”™è¯¯ ---->   æ–‡ä»¶æ‰“å¼€æ•°é‡é™åˆ¶ `ulimit -a`

![image-20240306231537525](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20240306231537525.png)

> 1. ä¿®æ”¹ulimit -n 1048576`ï¼ˆ2^20ï¼‰
>
> 2. åŒæ—¶ä¿®æ”¹ç¨‹åºé“¾æ¥æ•°ç»„çš„å¤§å°ï¼Œä¸é‡‡ç”¨å›ºå®šå¤§å°
>
> 3. å¦å¤–ï¼Œ`fs.file-max = 1048576 `
>
>    ```bash
>    sudo vim /etc/sysctl.conf
>    #å¦‚æœæ²¡è®¾ç½®åˆ™æ·»åŠ 
>    #è®¾ç½®å®Œååˆ·æ–°ç”Ÿæ•ˆ
>    sudo sysctl -p
>                   
>    ```



**2ï¸âƒ£ ç«¯å£æ•°é‡é™åˆ¶**

- ä¸€ä¸ª`socket` ï¼š`fd`  + `tcb(sip, dip, sport, dport, proto)`ï¼Œ å¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œæºç«¯å£ï¼ˆä¸¤ä¸ªå­—èŠ‚ï¼‰ï¼Œæœ€å¤§65535ï¼Œå¹¶ä¸”0-1023çš„ç«¯å£ä¸ºç³»ç»Ÿç‰¹å®šç«¯å£ä¸èƒ½éšæœºåˆ†é…ï¼Œæ‰€ä»¥å½“é“¾æ¥æ•°é‡è¾¾åˆ° ä¸€å®šæ•°é‡(65535-1024)æ—¶ï¼Œé“¾æ¥æ— æ³•å†å»ºç«‹äº†

> è§£å†³åŠæ³•ï¼šè€ƒè™‘é“¾æ¥çš„äº”å…ƒç»„
>
> 1. å¤šç”¨å‡ ä¸ªå®¢æˆ·ç«¯ï¼Œä¿è¯æºipä¸ä¸€æ ·-> n * (65535-1024)
> 2. å¤šç”¨å‡ ä¸ªç›®çš„ç«¯å£ -> n * (65535-1024)ï¼ŒåŒæ—¶å®¢æˆ·ç«¯è¿æ¥æ—¶ä¹Ÿç”¨é“¾æ¥åˆ°æœåŠ¡ç«¯çš„å¤šä¸ªç«¯å£

![image-20240309234111486](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20240309234111486.png)

- ç«¯å£èŒƒå›´é™åˆ¶ï¼š

> å°† 
>
> ```bash
> vim /etc/sysctl.conf
> ```
>
> ä¸­çš„`net.ipv4.ip_local_port_range = 1-24 65535`æ‹·è´åˆ°
>
> ```bash
> sudo vim /etc/sysctl.conf
> 
> #æ‹·è´å®Œåç”Ÿæ•ˆ
> sudo sysctl -p
> ```



**3ï¸âƒ£ å†…æ ¸ç¼“å†²åŒºé™åˆ¶**

- æ”¹æœåŠ¡ç«¯çš„tcbé…ç½®ï¼ˆé“¾æ¥åŒæ–¹ä¸‹é¢å‡ ä¸ªé…ç½®ä¿æŒä¸€æ ·ï¼‰

![image-20240307001227946](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20240307001227946.png)

```bash
sudo vim /etc/sysctl.conf
#å†™å…¥ä¸Šé¢å‡ ä¸ªé…ç½®
sudo sysctl -p
```

æ‰§è¡Œå®Œä¸Šé¢å‘½ä»¤ä¹‹åï¼ŒæŠ¥é”™ï¼š

![image-20240307001544910](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20240307001544910.png)

æ‰§è¡Œï¼š`sudo modprobe ip_conntrack`

- å¢åŠ `/etc/sysctl.conf`ä¸­çš„`net.ipv4.tcp_mem ` ã€ `net.ipv4.tcp_wmem` ã€ `net.ipv4.tcp_rmem`



