# Golang

# æ•°æ®ç»“æ„

## channel

> Go è¯­è¨€ä¸­çš„ **Channelï¼ˆé€šé“ï¼‰** æ˜¯ç”¨äº Goroutine ä¹‹é—´é€šä¿¡å’ŒåŒæ­¥çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œå…¶åº•å±‚å®ç°ç»“åˆäº†é«˜æ•ˆçš„å¹¶å‘æ§åˆ¶å’Œå†…å­˜ç®¡ç†ã€‚ä»¥ä¸‹æ˜¯ Channel çš„åº•å±‚ç»“æ„å’Œå·¥ä½œåŸç†çš„è¯¦ç»†åˆ†æï¼š
>
> ---
>
> ### **1. Channel çš„åº•å±‚ç»“æ„**
>
> Channel çš„åº•å±‚ç”± `runtime.hchan` ç»“æ„ä½“è¡¨ç¤ºï¼ˆå®šä¹‰åœ¨ `runtime/chan.go` ä¸­ï¼‰ï¼Œæ ¸å¿ƒå­—æ®µå¦‚ä¸‹ï¼š
>
> ```go
> type hchan struct {
>     qcount   uint           // å½“å‰é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°é‡ï¼ˆç¼“å†²åŒºå·²å­˜æ•°æ®é‡ï¼‰
>     dataqsiz uint           // ç¼“å†²åŒºçš„å¤§å°ï¼ˆå®¹é‡ï¼‰
>     buf      unsafe.Pointer // æŒ‡å‘ç¯å½¢ç¼“å†²åŒºçš„æŒ‡é’ˆ
>     elemsize uint16         // å…ƒç´ ç±»å‹çš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰
>     closed   uint32         // æ˜¯å¦å·²å…³é—­ï¼ˆ0-æœªå…³é—­ï¼Œ1-å·²å…³é—­ï¼‰
>     elemtype *_type         // å…ƒç´ ç±»å‹çš„å…ƒä¿¡æ¯ï¼ˆç”¨äºç±»å‹æ£€æŸ¥ï¼‰
>     sendx    uint           // å‘é€ç´¢å¼•ï¼ˆæŒ‡å‘ç¼“å†²åŒºä¸‹ä¸€ä¸ªå†™å…¥ä½ç½®ï¼‰
>     recvx    uint           // æ¥æ”¶ç´¢å¼•ï¼ˆæŒ‡å‘ç¼“å†²åŒºä¸‹ä¸€ä¸ªè¯»å–ä½ç½®ï¼‰
>     recvq    waitq          // ç­‰å¾…æ¥æ”¶çš„ Goroutine é˜Ÿåˆ—ï¼ˆåŒå‘é“¾è¡¨ï¼‰
>     sendq    waitq          // ç­‰å¾…å‘é€çš„ Goroutine é˜Ÿåˆ—ï¼ˆåŒå‘é“¾è¡¨ï¼‰
>     lock     mutex          // äº’æ–¥é”ï¼ˆä¿æŠ¤ Channel çš„å¹¶å‘æ“ä½œï¼‰
> }
> ```
>
> #### **å…³é”®æˆå‘˜è¯´æ˜**
>
> - **`buf`**ï¼šæŒ‡å‘ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼ˆåªæœ‰å½“ Channel æ˜¯å¸¦ç¼“å†²çš„æ—¶æ‰ä¼šåˆ†é…ï¼‰ã€‚
> - **`sendq` å’Œ `recvq`**ï¼šç­‰å¾…é˜Ÿåˆ—ï¼Œå­˜å‚¨å›  Channel æ»¡/ç©ºè€Œé˜»å¡çš„ Goroutineï¼ˆé€šè¿‡ `sudog` ç»“æ„ä½“è¡¨ç¤ºï¼‰ã€‚
> - **`lock`**ï¼šäº’æ–¥é”ï¼Œä¿è¯å¯¹ Channel æ“ä½œçš„åŸå­æ€§ï¼ˆä¾‹å¦‚å¹¶å‘å‘é€å’Œæ¥æ”¶ï¼‰ã€‚
>
> ---
>
> ### **2. Channel çš„å·¥ä½œåŸç†**
>
> Channel çš„è¡Œä¸ºç”±å…¶ç±»å‹ï¼ˆæ— ç¼“å†²æˆ–æœ‰ç¼“å†²ï¼‰å†³å®šï¼Œä½†åº•å±‚æœºåˆ¶æ˜¯ç»Ÿä¸€çš„ã€‚
>
> #### **2.1 å‘é€æ•°æ®ï¼ˆ`ch <- val`ï¼‰**
>
> 1. **åŠ é”**ï¼šé€šè¿‡ `lock` äº’æ–¥é”ä¿æŠ¤ Channel çš„å¹¶å‘æ“ä½œã€‚
> 2. **ç›´æ¥å†™å…¥ç¼“å†²åŒºï¼ˆå¦‚æœå¯èƒ½ï¼‰**ï¼š
>    - å¦‚æœç¼“å†²åŒºæœªæ»¡ï¼Œå°†æ•°æ®å†™å…¥ `buf` çš„ `sendx` ä½ç½®ï¼Œæ›´æ–° `sendx` å’Œ `qcount`ã€‚
> 3. **é˜»å¡ç­‰å¾…ï¼ˆå¦‚æœç¼“å†²åŒºå·²æ»¡ï¼‰**ï¼š
>    - å¦‚æœ Channel æ˜¯æ— ç¼“å†²çš„ï¼Œæˆ–è€…ç¼“å†²åŒºå·²æ»¡ï¼Œå½“å‰ Goroutine ä¼šè¢«å°è£…ä¸º `sudog`ï¼ŒåŠ å…¥ `sendq` é˜Ÿåˆ—ã€‚
>    - è°ƒç”¨ `gopark` æŒ‚èµ·å½“å‰ Goroutineï¼Œç­‰å¾…è¢«å”¤é†’ã€‚
> 4. **å”¤é†’æ¥æ”¶è€…ï¼ˆå¦‚æœæœ‰ç­‰å¾…çš„æ¥æ”¶è€…ï¼‰**ï¼š
>    - å¦‚æœ `recvq` é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œç›´æ¥å°†æ•°æ®ä¼ é€’ç»™ç¬¬ä¸€ä¸ªç­‰å¾…çš„æ¥æ”¶è€…ï¼Œå¹¶å”¤é†’å…¶ Goroutineã€‚
>
> #### **2.2 æ¥æ”¶æ•°æ®ï¼ˆ`val := <-ch`ï¼‰**
>
> 1. **åŠ é”**ï¼šåŒæ ·é€šè¿‡ `lock` ä¿æŠ¤æ“ä½œã€‚
> 2. **ç›´æ¥ä»ç¼“å†²åŒºè¯»å–ï¼ˆå¦‚æœå¯èƒ½ï¼‰**ï¼š
>    - å¦‚æœç¼“å†²åŒºéç©ºï¼Œä» `recvx` ä½ç½®è¯»å–æ•°æ®ï¼Œæ›´æ–° `recvx` å’Œ `qcount`ã€‚
> 3. **é˜»å¡ç­‰å¾…ï¼ˆå¦‚æœç¼“å†²åŒºä¸ºç©ºï¼‰**ï¼š
>    - å¦‚æœ Channel æ˜¯æ— ç¼“å†²çš„ï¼Œæˆ–è€…ç¼“å†²åŒºä¸ºç©ºï¼Œå½“å‰ Goroutine è¢«åŠ å…¥ `recvq` é˜Ÿåˆ—ã€‚
>    - è°ƒç”¨ `gopark` æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’ã€‚
> 4. **å”¤é†’å‘é€è€…ï¼ˆå¦‚æœæœ‰ç­‰å¾…çš„å‘é€è€…ï¼‰**ï¼š
>    - å¦‚æœ `sendq` é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œä»ç¬¬ä¸€ä¸ªç­‰å¾…çš„å‘é€è€…è·å–æ•°æ®ï¼ˆæˆ–ç›´æ¥å†™å…¥ç¼“å†²åŒºï¼‰ï¼Œå¹¶å”¤é†’å…¶ Goroutineã€‚
>
> #### **2.3 å…³é—­ Channelï¼ˆ`close(ch)`ï¼‰**
>
> 1. **åŠ é”**ï¼šç¡®ä¿åŸå­æ€§ã€‚
> 2. **æ ‡è®° Channel ä¸ºå…³é—­çŠ¶æ€**ï¼šè®¾ç½® `closed = 1`ã€‚
> 3. **å”¤é†’æ‰€æœ‰ç­‰å¾…çš„ Goroutine**ï¼š
>    - å°† `sendq` å’Œ `recvq` é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ Goroutine å”¤é†’ï¼Œæ¥æ”¶è€…ä¼šæ”¶åˆ°é›¶å€¼ï¼Œå‘é€è€…ä¼šè§¦å‘ panicã€‚
>
> ---
>
> ### **3. æ— ç¼“å†² Channel vs å¸¦ç¼“å†² Channel**
>
> - **æ— ç¼“å†² Channelï¼ˆ`make(chan T)`ï¼‰**ï¼š
>   - å‘é€å’Œæ¥æ”¶å¿…é¡»åŒæ­¥å®Œæˆï¼ˆç›´æ¥ä¼ é€’æ•°æ®ï¼Œä¸ç»è¿‡ç¼“å†²åŒºï¼‰ã€‚
>   - å¸¸ç”¨äº Goroutine é—´çš„ç²¾ç¡®åŒæ­¥ã€‚
> - **å¸¦ç¼“å†² Channelï¼ˆ`make(chan T, size)`ï¼‰**ï¼š
>   - å…è®¸åœ¨ç¼“å†²åŒºæœªæ»¡æ—¶å¼‚æ­¥å‘é€ï¼Œæˆ–åœ¨ç¼“å†²åŒºéç©ºæ—¶å¼‚æ­¥æ¥æ”¶ã€‚
>   - é€‚ç”¨äºè§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œæé«˜ååé‡ã€‚
>
> ---
>
> ### **4. åº•å±‚å®ç°çš„ä¼˜åŒ–**
>
> - **ç¯å½¢ç¼“å†²åŒº**ï¼šé€šè¿‡ `sendx` å’Œ `recvx` ç´¢å¼•å®ç°å¾ªç¯åˆ©ç”¨å†…å­˜ï¼Œé¿å…é¢‘ç¹å†…å­˜åˆ†é…ã€‚
> - **ç­‰å¾…é˜Ÿåˆ—ï¼ˆ`sendq` å’Œ `recvq`ï¼‰**ï¼šé€šè¿‡åŒå‘é“¾è¡¨ç®¡ç†é˜»å¡çš„ Goroutineï¼Œç¡®ä¿å…¬å¹³å”¤é†’ï¼ˆFIFOï¼‰ã€‚
> - **é›¶æ‹·è´ä¼˜åŒ–**ï¼šå½“å‘é€è€…å’Œæ¥æ”¶è€…ç›´æ¥ä¼ é€’æ•°æ®æ—¶ï¼Œé¿å…é€šè¿‡ç¼“å†²åŒºå¤åˆ¶æ•°æ®ã€‚
>
> 

## slice

> #### 1ï¸âƒ£ åº•å±‚ç»“æ„
>
> ```go
> type SliceHeader struct {
>  Data uintptr
>  Len  int
>  Cap  int
> }
> ```
>
> #### 2ï¸âƒ£ åˆ‡ç‰‡çš„æ·±æµ…æ‹·è´
>
> - ä½¿ç”¨=æ“ä½œç¬¦æ‹·è´åˆ‡ç‰‡ï¼Œè¿™ç§å°±æ˜¯æµ…æ‹·è´
> - ä½¿ç”¨[:]ä¸‹æ ‡çš„æ–¹å¼å¤åˆ¶åˆ‡ç‰‡ï¼Œè¿™ç§ä¹Ÿæ˜¯æµ…æ‹·è´
> - ä½¿ç”¨Goè¯­è¨€çš„å†…ç½®å‡½æ•°copy()è¿›è¡Œåˆ‡ç‰‡æ‹·è´ï¼Œè¿™ç§å°±æ˜¯æ·±æ‹·è´ï¼Œ
>
> #### 3ï¸âƒ£ ç©ºåˆ‡ç‰‡ã€é›¶åˆ‡ç‰‡ã€nilåˆ‡ç‰‡
>
> - åˆ‡ç‰‡
>
> æˆ‘ä»¬æŠŠåˆ‡ç‰‡å†…éƒ¨æ•°ç»„çš„å…ƒç´ éƒ½æ˜¯é›¶å€¼æˆ–è€…åº•å±‚æ•°ç»„çš„å†…å®¹å°±å…¨æ˜¯ nilçš„åˆ‡ç‰‡å«åšé›¶åˆ‡ç‰‡ï¼Œä½¿ç”¨makeåˆ›å»ºçš„ã€é•¿åº¦ã€å®¹é‡éƒ½ä¸ä¸º0çš„åˆ‡ç‰‡å°±æ˜¯é›¶å€¼åˆ‡ç‰‡ï¼š
>
> ```go
> slice := make([]int,5) // 0 0 0 0 0
> slice := make([]*int,5) // nil nil nil nil nil
> ```
>
> - nilåˆ‡ç‰‡
>
> nilåˆ‡ç‰‡çš„é•¿åº¦å’Œå®¹é‡éƒ½ä¸º0ï¼Œå¹¶ä¸”å’Œnilæ¯”è¾ƒçš„ç»“æœä¸ºtrueï¼Œé‡‡ç”¨ç›´æ¥åˆ›å»ºåˆ‡ç‰‡çš„æ–¹å¼ã€newåˆ›å»ºåˆ‡ç‰‡çš„æ–¹å¼éƒ½å¯ä»¥åˆ›å»ºnilåˆ‡ç‰‡ï¼š
>
> ```go
> var slice []int
> var slice = *new([]int)
> ```
>
> - ç©ºåˆ‡ç‰‡
>
> ç©ºåˆ‡ç‰‡çš„é•¿åº¦å’Œå®¹é‡ä¹Ÿéƒ½ä¸º0ï¼Œä½†æ˜¯å’Œnilçš„æ¯”è¾ƒç»“æœä¸ºfalseï¼Œå› ä¸ºæ‰€æœ‰çš„ç©ºåˆ‡ç‰‡çš„æ•°æ®æŒ‡é’ˆéƒ½æŒ‡å‘åŒä¸€ä¸ªåœ°å€ 0xc42003bda0ï¼›ä½¿ç”¨å­—é¢é‡ã€makeå¯ä»¥åˆ›å»ºç©ºåˆ‡ç‰‡ï¼š
>
> ```go
> var slice = []int{}
> var slice = make([]int, 0)
> ```
>
> ç©ºåˆ‡ç‰‡æŒ‡å‘çš„ zerobase å†…å­˜åœ°å€æ˜¯ä¸€ä¸ªç¥å¥‡çš„åœ°å€ï¼Œä» Go è¯­è¨€çš„æºä»£ç ä¸­å¯ä»¥çœ‹åˆ°å®ƒçš„å®šä¹‰ï¼š
>
> ```go
> // base address for all 0-byte allocations
> var zerobase uintptr
> 
> // åˆ†é…å¯¹è±¡å†…å­˜
> func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer {
>  ...
>  if size == 0 {
>   return unsafe.Pointer(&zerobase)
>  }
>   ...
> }
> ```
>
> #### 4ï¸âƒ£ æ‰©å®¹æœºåˆ¶
>
> åˆ‡ç‰‡åœ¨æ‰©å®¹æ—¶ä¼šè¿›è¡Œå†…å­˜å¯¹é½ï¼Œè¿™ä¸ªå’Œå†…å­˜åˆ†é…ç­–ç•¥ç›¸å…³ã€‚è¿›è¡Œå†…å­˜å¯¹é½ä¹‹åï¼Œæ–° slice çš„å®¹é‡æ˜¯è¦ å¤§äºç­‰äºè€ slice å®¹é‡çš„ 2å€æˆ–è€…1.25å€ï¼Œå½“åŸ slice å®¹é‡å°äº 1024 çš„æ—¶å€™ï¼Œæ–° slice å®¹é‡å˜æˆåŸæ¥çš„ 2 å€ï¼›åŸ slice å®¹é‡è¶…è¿‡ 1024ï¼Œæ–° slice å®¹é‡å˜æˆåŸæ¥çš„1.25å€ã€‚
>
> - ä¸ºä»€ä¹ˆï¼Ÿä»¥æˆ‘çš„ç†è§£ï¼Œåœ¨1024ä¸€ä¸‹é€šè¿‡ä¸¤å€è¿…é€Ÿçš„æ‰©å¤§ç©ºé—´ï¼Œé˜²æ­¢é¢‘ç¹çš„æ‰©å®¹è€—æ—¶ï¼Œè€Œåœ¨**å¤§å®¹é‡æ—¶æ”¹ä¸º 1.25 å€å¢é•¿** é¿å…æµªè´¹å¤§é‡å†…å­˜ã€‚
>
> 

# å¹¶å‘

## GMPæ¨¡å‹

> <img src="https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20250203%E4%B8%8B%E5%8D%8814847493.png" alt="image-20250203ä¸‹åˆ14847493" style="zoom:50%;" />
>
> - æ–°å»º `G` æ—¶ï¼Œæ–°`G`ä¼šä¼˜å…ˆåŠ å…¥åˆ° `P` çš„æœ¬åœ°é˜Ÿåˆ—ï¼›å¦‚æœæœ¬åœ°é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„ `G` ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚
> - `P` çš„æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå°±ä»å…¨å±€é˜Ÿåˆ—é‡Œå»å–ã€‚
>
> 
>
> ### 1. Goroutineï¼ˆGï¼‰
>
> - Goroutine æ˜¯ Go ä¸­çš„å¹¶å‘æ‰§è¡Œå•å…ƒï¼Œç±»ä¼¼äºçº¿ç¨‹ï¼Œä½†æ¯”çº¿ç¨‹æ›´åŠ è½»é‡çº§ã€‚æ¯ä¸ª Goroutine æœ‰ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼Œæ ˆçš„å¤§å°ä¼šåŠ¨æ€æ‰©å±•ï¼Œåˆå§‹æ ˆå¤§å°å¾ˆå°ï¼ˆçº¦ 2KBï¼‰ã€‚
> - Goroutine æ˜¯ç”± Go è¿è¡Œæ—¶è°ƒåº¦çš„ï¼Œå¹¶ä¸ç›´æ¥å¯¹åº”æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡ GMP æ¨¡å‹åœ¨å¤šä¸ª OS çº¿ç¨‹ä¸Šé«˜æ•ˆè°ƒåº¦ã€‚
>
> ### 2. Machineï¼ˆMï¼‰
>
> - M ä»£è¡¨æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œæ˜¯ Go è¿è¡Œæ—¶ç”¨æ¥å®é™…æ‰§è¡Œ Goroutine çš„å®ä½“ã€‚
> - æ¯ä¸ª M è¿è¡Œæ—¶è´Ÿè´£æ‰§è¡Œ Goroutine çš„ä»£ç ï¼ŒM å¯ä»¥æ˜¯æ“ä½œç³»ç»Ÿçš„å†…æ ¸çº¿ç¨‹ï¼ŒGo è¿è¡Œæ—¶ä¼šæ ¹æ®éœ€è¦åŠ¨æ€åœ°åˆ›å»ºæˆ–é”€æ¯ Mã€‚
> - M è´Ÿè´£æ‰§è¡Œå…·ä½“çš„è®¡ç®—ä»»åŠ¡ï¼Œå®ƒä¸ Goroutine æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œä¸€ä¸ª M å¯ä»¥æ‰§è¡Œå¤šä¸ª Goroutineï¼Œä½†ä¸€ä¸ª Goroutine åœ¨æŸä¸€æ—¶åˆ»åªèƒ½åœ¨ä¸€ä¸ª M ä¸Šæ‰§è¡Œã€‚
> - åˆå§‹åŒ–æ•°é‡ï¼šGoç¨‹åºå¯åŠ¨æ—¶ï¼Œ**åˆå§‹Mçš„æ•°é‡é€šå¸¸ç­‰äº`GOMAXPROCS`çš„å€¼**ï¼ˆå³é€»è¾‘å¤„ç†å™¨çš„æ•°é‡ï¼Œé»˜è®¤ç­‰äºCPUæ ¸å¿ƒæ•°ï¼‰ã€‚
>
> ### 3. Processorï¼ˆPï¼‰
>
> - P ä»£è¡¨é€»è¾‘å¤„ç†å™¨ï¼Œç”¨æ¥æ§åˆ¶ Goroutine çš„è°ƒåº¦ã€‚P çš„æ•°é‡é€šå¸¸ç”±ç”¨æˆ·é€šè¿‡ `GOMAXPROCS` è®¾ç½®ï¼Œè¡¨ç¤ºå¯ä»¥åŒæ—¶è¿è¡Œ Goroutine çš„æœ€å¤§å¹¶å‘æ•°é‡ï¼ˆå³é€»è¾‘ CPU æ ¸å¿ƒæ•°ï¼‰ã€‚
> - P ç®¡ç†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­ä¿å­˜å¾…æ‰§è¡Œçš„ Goroutineã€‚å½“ P å’Œ M å…³è”æ—¶ï¼ŒP ä¼šå°†è‡ªå·±é˜Ÿåˆ—ä¸­çš„ Goroutine åˆ†é…ç»™ M æ‰§è¡Œã€‚
> - æ¯ä¸ª P åªä¼šç»‘å®šä¸€ä¸ª Mï¼ŒM åªèƒ½åœ¨ä¸å…¶å…³è”çš„ P ä¸Šè°ƒåº¦ Goroutineã€‚
> - P çš„æ•°é‡é™åˆ¶äº†ç³»ç»Ÿçš„å¹¶å‘åº¦ï¼Œå³å³ä½¿æœ‰å¾ˆå¤š M å’Œ Goroutineï¼Œä¹Ÿåªæœ‰ P å…è®¸çš„æ•°é‡å¹¶å‘æ‰§è¡Œã€‚
>
> ### GMP æ¨¡å‹çš„å·¥ä½œåŸç†
>
> 1. å½“ç¨‹åºå¯åŠ¨æ—¶ï¼ŒGo è¿è¡Œæ—¶ä¼šåˆå§‹åŒ–ä¸€ç»„ Pï¼ˆé€»è¾‘å¤„ç†å™¨ï¼‰ï¼ŒP çš„æ•°é‡å¯ä»¥é€šè¿‡ `runtime.GOMAXPROCS` è®¾ç½®ï¼Œé»˜è®¤å€¼æ˜¯ç³»ç»Ÿ CPU æ ¸å¿ƒæ•°ã€‚
> 2. Goroutine è¢«åˆ›å»ºæ—¶ï¼Œè¿è¡Œæ—¶ä¼šå°†å®ƒæ”¾å…¥æŸä¸ª P çš„æœ¬åœ°é˜Ÿåˆ—ä¸­ã€‚
> 3. M æ˜¯æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹ï¼Œå½“ M å¯åŠ¨æ—¶ï¼Œå®ƒéœ€è¦ä¸ä¸€ä¸ª P å…³è”æ‰èƒ½å¼€å§‹æ‰§è¡Œ Goroutineã€‚P å†³å®šå°†å“ªäº› Goroutine åˆ†é…ç»™ M è¿è¡Œã€‚
> 4. å¦‚æœ M å‘ç° P çš„é˜Ÿåˆ—ä¸­æ²¡æœ‰å¯è¿è¡Œçš„ Goroutineï¼Œå®ƒä¼šå°è¯•ä»å…¶ä»– P çš„é˜Ÿåˆ—ä¸­çªƒå– Goroutine æ¥æ‰§è¡Œï¼Œè¿™ç§°ä¸ºå·¥ä½œçªƒå–ï¼ˆ**work stealing**ï¼‰ã€‚
> 5. å½“ä¸€ä¸ª M å¤„äº I/O é˜»å¡çŠ¶æ€æˆ–å‘ç”Ÿç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒM ä¼šé‡Šæ”¾ Pï¼Œè®©å…¶ä»– M å¯ä»¥åˆ©ç”¨è¿™ä¸ª P ç»§ç»­æ‰§è¡Œ Goroutineã€‚
> 6. å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ M æ¥è¿è¡Œ P é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼ŒGo è¿è¡Œæ—¶ä¼šåŠ¨æ€åˆ›å»ºæ–°çš„ Mï¼Œåä¹‹å¦‚æœæœ‰å¤šä½™çš„ Mï¼ŒM ä¹Ÿä¼šè¢«é”€æ¯ã€‚
>
> 
>
> ###  work stealing 
>
> å½“æœ¬çº¿ç¨‹â½†å¯è¿ï¨ˆçš„Gæ—¶ï¼Œå°è¯•ä»å…¶ä»–çº¿ç¨‹ç»‘å®šçš„På·å–Gï¼Œâ½½ä¸æ˜¯é”€æ¯çº¿ç¨‹ã€‚å…ˆå…¨å±€é˜Ÿåˆ—ï¼Œåæœ¬åœ°é˜Ÿåˆ—
>
> ### hand off
>
> å½“æœ¬çº¿ç¨‹å› ä¸ºGè¿›ï¨ˆç³»ç»Ÿè°ƒç”¨é˜»å¡æ—¶ï¼Œçº¿ç¨‹é‡Šæ”¾ç»‘å®šçš„Pï¼ŒæŠŠPè½¬ç§»ç»™å…¶ä»–ç©ºé—²çš„çº¿ç¨‹æ‰§â¾ã€‚
>
> 
>
> ### go func()åœ¨GMPä¸Šçš„æµç¨‹
>
> - åˆ›å»ºG â€”â€”ã€‹ç»‘å®šåˆ°æ‰§è¡Œå½“å‰æ“ä½œçš„Mä¸Šçš„æœ¬åœ°é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœæ»¡äº†åˆ™æ”¾å…¥å…¨å±€é˜Ÿåˆ— â€”â€”ã€‰Mè°ƒåº¦å¹¶æ‰§è¡ŒG â€”â€”ã€‹æ—¶é—´ç‰‡æ¶ˆè€—å®Œä¹‹ååŠ å…¥æœ¬åœ°é˜Ÿåˆ—
>
> - å½“Gå‘ç”Ÿé˜»å¡ï¼Œæ­¤æ—¶å”¤é†’ä¸€ä¸ªä¼‘çœ çš„Mæˆ–è€…æ–°å»ºæ¥æ¥ç®¡å½“å‰çš„Pï¼Œä¹‹åé˜»å¡çš„Gä¸ä¹‹å‰çš„Mæ†ç»‘ï¼Œå½“Gå”¤é†’ä¹‹åè¢«æ”¾å…¥å…¨å±€é˜Ÿåˆ—ï¼Œæ—§çš„MåŠ å…¥ä¼‘çœ çš„Mé˜Ÿåˆ—æˆ–é”€æ¯
>
> ![image-20250204ä¸‹åˆ20930874](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20250204%E4%B8%8B%E5%8D%8820930874.png)
>
> #### æœ¬åœ°é˜Ÿåˆ—æ²¡æœ‰Gäº†ï¼Œé‚£ä¹ˆä¼šå…ˆå»å…¨å±€é˜Ÿåˆ—é‡Œæ‹¿è¿˜æ˜¯å…ˆå»å…¶ä»–Pçš„é˜Ÿåˆ—é‡Œæ‹¿
>
> 1ï¸âƒ£ **å…ˆå°è¯•ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—ï¼ˆGlobal Queueï¼‰è·å– G**
>
> â€‹	â€¢	P **é¦–å…ˆ** ä¼šå» **å…¨å±€é˜Ÿåˆ—** å– Gï¼Œå› ä¸ºå…¨å±€é˜Ÿåˆ—å­˜æ”¾çš„æ˜¯æ–°å»ºçš„æˆ–å› ç³»ç»Ÿè°ƒç”¨è¢«æ”¾å›çš„ Gã€‚
>
> â€‹	â€¢	å–çš„æ•°é‡é€šå¸¸æ˜¯ **æœ€å¤š 32 ä¸ª** æˆ–å…¨å±€é˜Ÿåˆ—é‡Œçš„ä¸€åŠï¼ˆå–è¾ƒå°å€¼ï¼‰ã€‚
>
> 
>
> 2ï¸âƒ£ **å¦‚æœå…¨å±€é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å°è¯•ä»å…¶ä»– P å·å–ï¼ˆWork Stealingï¼‰**
>
> â€‹	â€¢	P **éšæœº** é€‰æ‹© **å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—**ï¼Œå°è¯•**å·å–**ï¼ˆWork Stealingï¼‰ä¸€åŠçš„ Gã€‚
>
> â€‹	â€¢	è¿™ç§æœºåˆ¶å¯ä»¥é˜²æ­¢æŸäº› P ä»»åŠ¡è¿‡å¤šï¼Œè€Œå¦ä¸€äº› P å¤„äºç©ºé—²çŠ¶æ€ï¼Œæé«˜è°ƒåº¦æ•ˆç‡ã€‚
>
> 
>
> 3ï¸âƒ£ **å¦‚æœä»ç„¶æ²¡æœ‰å¯è¿è¡Œçš„ Gï¼Œé‚£ä¹ˆ P ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€**
>
> â€‹	â€¢	P ä¼šé€šè¿‡ park è¿›å…¥**ä¼‘çœ **çŠ¶æ€ï¼Œç­‰å¾…æ–°çš„ G å¯æ‰§è¡Œã€‚
>
> â€‹	â€¢	å¦‚æœæ‰€æœ‰ P éƒ½æ²¡æœ‰ Gï¼Œé‚£ä¹ˆ Mï¼ˆæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼‰ ä¹Ÿå¯èƒ½è¿›å…¥ä¼‘çœ ï¼Œæœ€ç»ˆ runtime å¯èƒ½ä¼šè¿›å…¥ idle çŠ¶æ€ã€‚
>
> 
>
> 



## sync.Pool

- **åŸºæœ¬ç”¨æ³•**

1. **å®šä¹‰ Pool**ï¼š

   ```go
   var bufferPool = &sync.Pool{
       New: func() interface{} {
           return new(bytes.Buffer) // å®šä¹‰åˆ›å»ºæ–°å¯¹è±¡çš„å‡½æ•°
       },
   }
   ```

2. **ä» Pool è·å–å¯¹è±¡**ï¼š

   ```go
   buf := bufferPool.Get().(*bytes.Buffer) // ç±»å‹æ–­è¨€
   defer bufferPool.Put(buf)               // ç”¨å®Œåæ”¾å›æ± ä¸­
   buf.Reset()                             // é‡ç½®å¯¹è±¡çŠ¶æ€ï¼ˆé¿å…è„æ•°æ®ï¼‰
   ```

3. **æ”¾å›å¯¹è±¡**ï¼š

   ```go
   bufferPool.Put(buf) // å¯¹è±¡æ”¾å›æ± ä¸­ï¼Œä¾›åç»­å¤ç”¨
   ```

- **é€‚ç”¨åœºæ™¯**

  > - éœ€è¦å‡å°‘å†…å­˜åˆ†é…å’Œ GC å‹åŠ›çš„åœºæ™¯ã€‚
  > - é«˜å¹¶å‘ä¸‹é¢‘ç¹åˆ›å»º/é”€æ¯å¯¹è±¡çš„åœºæ™¯ã€‚

- **åŠŸèƒ½**

> **å¯¹è±¡å¤ç”¨**ï¼š
>
> - å½“ç¨‹åºéœ€è¦é¢‘ç¹åˆ›å»ºå’Œé”€æ¯æŸäº›å¯¹è±¡æ—¶ï¼ˆä¾‹å¦‚ç¼“å†²åŒºã€ä¸´æ—¶ç»“æ„ä½“ç­‰ï¼‰ï¼Œ`sync.Pool` ä¼šå°†è¿™äº›å¯¹è±¡ç¼“å­˜èµ·æ¥ï¼Œåç»­éœ€è¦æ—¶ç›´æ¥ä»æ± ä¸­è·å–ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ†é…å†…å­˜ã€‚
> - å¤ç”¨å¯¹è±¡å¯æ˜¾è‘—å‡å°‘å†…å­˜åˆ†é…æ¬¡æ•°ï¼Œé™ä½ GC çš„å·¥ä½œé‡ã€‚
>
> **è‡ªåŠ¨æ¸…ç†**ï¼š
>
> - æ± ä¸­çš„å¯¹è±¡å¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰è‡ªåŠ¨æ¸…ç†ï¼ˆGo 1.13 ä¹‹å‰æ˜¯ä¸¤è½® GC åæ¸…ç†ï¼Œä¹‹åä¼˜åŒ–ä¸ºæ¯æ¬¡ GC éƒ½å¯èƒ½æ¸…ç†ï¼‰ã€‚
> - å› æ­¤ï¼Œ`sync.Pool` é€‚åˆå­˜å‚¨**ä¸´æ—¶å¯¹è±¡**ï¼Œä¸èƒ½ä¾èµ–å®ƒä¿å­˜é•¿æœŸä½¿ç”¨çš„æ•°æ®ã€‚





# å†…å­˜

## GC

- **ğŸ’¡ç›®æ ‡**ï¼š**åœ¨ä¿è¯å¯¹è±¡ä¸ä¸¢å¤±çš„æƒ…å†µä¸‹æé«˜GCæ•ˆç‡ï¼Œå‡å°‘STWæ—¶é—´**



### ä¸‰è‰²æ ‡è®°æ³•æ— STWå¯èƒ½äº§ç”Ÿçš„é—®é¢˜

cond1:**é»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡** â€”â€”ã€‹å¼ºä¸‰è‰²ä¸å˜å¼è§£å†³ â€”â€”ã€‰æ’å…¥å†™å±éšœ

cond2:**åŒæ—¶åŸæœ¬çš„æŒ‡å‘ç™½è‰²å¯¹è±¡çš„ç°è‰²å¯¹è±¡çš„å¼•ç”¨ä¸¢å¤±** â€”â€”ã€‹å¼±ä¸‰è‰²ä¸å˜å¼è§£å†³ â€”â€”ã€‰åˆ é™¤å†™å±éšœ

åœ¨æ²¡æœ‰STWçš„æƒ…å†µä¸‹ï¼Œå¦‚æœåŒæ—¶æ»¡è¶³ä¸Šè¿°æ¡ä»¶ï¼Œåˆ™ä¼šå‡ºç°å¯¹è±¡ä¸¢å¤±çš„æƒ…å†µ

ğŸ’¡**è§£å†³åŠæ³•**ï¼š

- å¼ºä¸‰è‰²ä¸å˜å¼

ä¸å…è®¸é»‘è‰²æŒ‡å‘ç™½è‰²

- å¼±ä¸‰è‰²ä¸å˜å¼

é»‘è‰²å¯ä»¥æŒ‡å‘ç™½è‰²ï¼Œä»…å½“ç™½è‰²ä¸Šæ¸¸æœ‰ç°è‰²å¼•ç”¨

### å±éšœæœºåˆ¶

1. **æ’å…¥å±éšœï¼ˆå¯¹è±¡è¢«å¼•ç”¨æ—¶è§¦å‘ï¼‰**

åœ¨Aå¯¹è±¡å¼•ç”¨Bæ—¶ï¼ŒBè¢«æ ‡è®°ä¸ºç°è‰² â€”â€” æ»¡è¶³å¼ºä¸‰è‰²ä¸å˜å¼

- ä¸åœ¨æ ˆä¸Šä½¿ç”¨ï¼ˆä¿è¯æ€§èƒ½ï¼‰â€”â€”åœ¨èµ°å®Œä¸€è¶Ÿä¸‰è‰²æ ‡è®°ä¹‹åï¼Œå°†æ ˆä¸Šçš„å¯¹è±¡ç½®ç™½ï¼Œé€šè¿‡STWé‡å†™èµ°ä¸‰è‰²æ ‡è®°

2. **åˆ é™¤å±éšœï¼ˆå¯¹è±¡è¢«åˆ é™¤æ—¶è§¦å‘ï¼‰**

è¢«åˆ é™¤çš„å¯¹è±¡å¦‚æœè‡ªèº«ä¸º ç°æˆ–ç™½ ï¼Œåˆ™è¢«æ ‡è®°ä¸ºç°

- å›æ”¶ç²¾åº¦ä½ï¼Œè¢«åˆ é™¤çš„å¯¹è±¡å¯èƒ½æ²¡æœ‰è¢«å…¶ä»–çš„å¯¹è±¡å¼•ç”¨ï¼Œä½†æ˜¯å½“å‰è¿™ä¸€è½®æœ€ç»ˆä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²

3. æ··åˆå†™å±éšœ

![image-20250204ä¸‹åˆ61843476](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20250204%E4%B8%8B%E5%8D%8861843476.png)

### è¿˜æœ‰å“ªäº›åœ°æ–¹éœ€è¦STW

**åˆå§‹é˜¶æ®µï¼ˆMark Terminationï¼‰**ï¼š

- GC å¼€å§‹æ—¶éœ€è¦çŸ­æš‚ STWï¼Œç”¨äºæ‰«ææ ¹å¯¹è±¡ï¼ˆå¦‚å…¨å±€å˜é‡ã€å½“å‰ Goroutine çš„æ ˆç­‰ï¼‰ï¼Œç¡®ä¿ä¸€è‡´æ€§ã€‚

**ç»ˆæ­¢é˜¶æ®µï¼ˆMark Terminationï¼‰**ï¼š

- åœ¨æ ‡è®°å®Œæˆåï¼Œä»éœ€æçŸ­æ—¶é—´çš„ STWï¼ˆé€šå¸¸å°äº 100Î¼sï¼‰ç¡®è®¤æ‰€æœ‰æ ‡è®°å·¥ä½œå®Œæˆï¼Œå¹¶åˆ‡æ¢ GC é˜¶æ®µï¼ˆå¦‚å¼€å¯æ¸…æ‰«é˜¶æ®µï¼‰ã€‚

## å†…å­˜é€ƒé€¸

åœ¨ Go è¯­è¨€ä¸­ï¼Œ**å†…å­˜é€ƒé€¸ï¼ˆEscape Analysisï¼‰** æ˜¯ç¼–è¯‘å™¨ä¼˜åŒ–çš„ä¸€éƒ¨åˆ†ã€‚Go çš„ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¿›è¡Œé€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰å†³å®šå˜é‡æ˜¯åœ¨æ ˆï¼ˆStackï¼‰ä¸Šåˆ†é…è¿˜æ˜¯åœ¨å †ï¼ˆHeapï¼‰ä¸Šåˆ†é…

**1ï¸âƒ£ ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿå†…å­˜é€ƒé€¸ï¼Ÿ**

åœ¨ Go è¯­è¨€ä¸­ï¼Œæ ˆçš„**å†…å­˜ç®¡ç†æ•ˆç‡é«˜**ï¼Œä½†å¤§å°æœ‰é™ï¼Œå¹¶ä¸”ä½œç”¨åŸŸä¹Ÿæœ‰é™ã€‚å› æ­¤ï¼ŒGo é€šè¿‡é€ƒé€¸åˆ†æå†³å®šæŸäº›å˜é‡æ˜¯å¦éœ€è¦åˆ†é…åˆ°å †ä¸Šã€‚

1ï¸âƒ£ **å˜é‡çš„ç”Ÿå‘½å‘¨æœŸè¶…å‡ºäº†å‡½æ•°ä½œç”¨åŸŸ**

â€‹	â€¢	å˜é‡å¦‚æœåœ¨å‡½æ•°è¿”å›åä»ç„¶è¢«ä½¿ç”¨ï¼Œå°±æ— æ³•å­˜å‚¨åœ¨æ ˆä¸Šï¼Œè€Œå¿…é¡»å­˜å‚¨åœ¨å †ä¸Šã€‚

```
func escapeExample() *int {
    x := 10 // x æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡
    return &x // x çš„åœ°å€è¢«è¿”å›ï¼Œx é€ƒé€¸åˆ°å †
}
```

2ï¸âƒ£ **å˜é‡è¢«èµ‹å€¼ç»™æ¥å£ç±»å‹**

â€‹	â€¢	ç”±äºæ¥å£æ˜¯ä¸€ä¸ªåŒ…å«**åŠ¨æ€ç±»å‹ä¿¡æ¯**çš„ç»“æ„ï¼ŒGo éœ€è¦åœ¨å †ä¸Šåˆ†é…å®é™…æ•°æ®ã€‚

```
func escapeToInterface() interface{} {
    s := "hello"
    return s // s é€ƒé€¸åˆ°å †ï¼Œå› ä¸ºå®ƒè¢«å­˜å…¥äº† interface{}
}
```

3ï¸âƒ£ **å˜é‡è¢«é—­åŒ…æ•è·**

â€‹	â€¢	Go çš„é—­åŒ…å¯èƒ½ä¼šåœ¨å‡½æ•°ä½œç”¨åŸŸå¤–ä½¿ç”¨æ•è·çš„å˜é‡ï¼Œå¯¼è‡´å˜é‡é€ƒé€¸ã€‚

```
func closureEscape() func() int {
    x := 42
    return func() int { // x è¢«é—­åŒ…å¼•ç”¨ï¼Œå› æ­¤é€ƒé€¸åˆ°å †
        return x
    }
}
```

4ï¸âƒ£ **å¤§å¯¹è±¡çš„åˆ†é…**

â€‹	â€¢Go ç¼–è¯‘å™¨å¯èƒ½ä¼šä¸ºäº†ä¼˜åŒ–æ ˆçš„ä½¿ç”¨ï¼Œå°†è¾ƒå¤§çš„å˜é‡åˆ†é…åˆ°å †ä¸Šï¼Œå³ä½¿å®ƒä»¬æ²¡æœ‰é€ƒé€¸ã€‚

```
func largeObject() {
    bigArray := make([]int, 1000000) // é€ƒé€¸åˆ°å †
    fmt.Println(bigArray[0])
}
```

5ï¸âƒ£ **å˜é‡çš„åœ°å€è¢«ä¼ é€’åˆ°å †ä¸Šçš„æ•°æ®ç»“æ„**

â€‹	â€¢	å¦‚æœå˜é‡çš„åœ°å€è¢«å­˜å‚¨åœ¨å †ä¸­çš„æ•°æ®ç»“æ„ä¸­ï¼Œå®ƒä¹Ÿä¼šé€ƒé€¸ã€‚

```
type Data struct {
    ptr *int
}

func escapeStruct() {
    x := 10
    d := &Data{ptr: &x} // x é€ƒé€¸åˆ°å †ï¼Œå› ä¸º &x è¢«å­˜å…¥äº†å †ä¸Šçš„ Data ç»“æ„
    fmt.Println(d)
}
```

**2ï¸âƒ£ å¦‚ä½•æ£€æµ‹å†…å­˜é€ƒé€¸ï¼Ÿ**

Go æä¾›äº† -gcflags="-m" é€‰é¡¹æ¥æŸ¥çœ‹ç¼–è¯‘å™¨çš„é€ƒé€¸åˆ†æï¼š

```
go run -gcflags="-m" main.go
```

ç¤ºä¾‹ï¼š

```
func main() {
    x := 10
    fmt.Println(&x) // å˜é‡ x é€ƒé€¸
}
```

è¿è¡Œï¼š

```
# è¾“å‡ºï¼ˆç¼–è¯‘å™¨ä¼šæç¤º x é€ƒé€¸ï¼‰
main.go:6:13: &x escapes to heap
```

**3ï¸âƒ£ å¦‚ä½•å‡å°‘å†…å­˜é€ƒé€¸ï¼Ÿ**

ä¸ºäº†ä¼˜åŒ–æ€§èƒ½ï¼Œå°½é‡å‡å°‘ä¸å¿…è¦çš„é€ƒé€¸ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

ğŸ”¹ **å°½é‡ä½¿ç”¨å€¼ç±»å‹è€Œä¸æ˜¯æŒ‡é’ˆç±»å‹**

```
func noEscape() int {
    x := 10
    return x // x æ²¡æœ‰é€ƒé€¸
}
```

ğŸ”¹ **é¿å…ä¸å¿…è¦çš„æ¥å£è½¬æ¢**

```
func avoidInterface() {
    s := "hello"
    fmt.Println(s) // s æ²¡æœ‰é€ƒé€¸
}
```

ğŸ”¹ **é¿å…é—­åŒ…æŒæœ‰å˜é‡çš„å¼•ç”¨**

```
func noClosureEscape() {
    x := 10
    func(y int) { fmt.Println(y) }(x) // ä¼ é€’å€¼ï¼Œè€Œä¸æ˜¯æ•è·å˜é‡
}
```

ğŸ”¹ **ä½¿ç”¨ sync.Pool è¿›è¡Œå¯¹è±¡å¤ç”¨**

```
import "sync"

var pool = sync.Pool{
    New: func() interface{} { return new(int) },
}

func usePool() {
    obj := pool.Get().(*int) // ä» pool è·å–å¯¹è±¡ï¼Œå‡å°‘é€ƒé€¸
    *obj = 42
    pool.Put(obj) // å½’è¿˜åˆ° pool
}
```

**4ï¸âƒ£ é€ƒé€¸çš„å½±å“**

âœ… **ä¼˜ç‚¹**

â€‹	â€¢	é€ƒé€¸åˆ°å †ä¸Šå¯ä»¥é¿å…æ ˆæº¢å‡ºï¼ˆæ ˆçš„å¤§å°æ˜¯æœ‰é™çš„ï¼‰ã€‚

âŒ **ç¼ºç‚¹**

â€‹	â€¢ç®¡ç†å¼€é”€ï¼šå †åˆ†é…çš„å†…å­˜éœ€è¦åƒåœ¾å›æ”¶ï¼ˆGCï¼‰ï¼Œæ¯”æ ˆä¸Šçš„å†…å­˜ç®¡ç†æˆæœ¬æ›´é«˜ã€‚

â€‹	â€¢è®¿é—®å¼€é”€ï¼šå †ä¸Šçš„æ•°æ®è®¿é—®é€Ÿåº¦æ¯”æ ˆæ…¢ã€‚



## æŒ‡é’ˆ

### uintptr

uintptr æ˜¯ Go è¯­è¨€ä¸­çš„ä¸€ç§**æ— ç¬¦å·æ•´æ•°ç±»å‹**ï¼Œå®ƒçš„å¤§å°ä¸æŒ‡é’ˆçš„å¤§å°ç›¸åŒï¼ˆé€šå¸¸ä¸º 32 ä½æˆ– 64 ä½ï¼‰ï¼Œç”¨äºå­˜å‚¨æŒ‡é’ˆçš„æ•°å€¼è¡¨ç¤ºã€‚

```go
package main

import (
	"fmt"
	"unsafe"
)

func main() {
	var x int = 100
	ptr := unsafe.Pointer(&x)     // *int â†’ unsafe.Pointer
	addr := uintptr(ptr)          // unsafe.Pointer â†’ uintptr
	newPtr := unsafe.Pointer(addr) // uintptr â†’ unsafe.Pointer
	fmt.Println(*(*int)(newPtr))  // 100
}
```

**âš ï¸ æ³¨æ„ï¼š** uintptr åªæ˜¯ä¸€ä¸ªæ•´æ•°ï¼ŒGC **ä¸ä¼š** è®¤ä¸ºå®ƒæ˜¯æŒ‡é’ˆï¼Œå› æ­¤åœ¨ uintptr å­˜åœ¨æœŸé—´ï¼ŒGC å¯èƒ½å›æ”¶ ptr æŒ‡å‘çš„å¯¹è±¡ï¼Œå¯¼è‡´æ‚¬ç©ºæŒ‡é’ˆã€‚



### unsafe.Pointer

- **unsafe.Pointer ä¸èƒ½å‚ä¸æŒ‡é’ˆè¿ç®—**

```go
p := unsafe.Pointer(uintptr(unsafe.Pointer(&x)) + 1) // âœ… æ­£ç¡®
p = unsafe.Pointer(&x + 1) // âŒ é”™è¯¯ï¼ŒGo ä¸æ”¯æŒæŒ‡é’ˆè¿ç®—
```

- **unsafe.Pointer çš„ä½œç”¨**

unsafe.Pointer ä¸»è¦ç”¨äº **ç»•è¿‡ Go è¯­è¨€çš„ç±»å‹å®‰å…¨é™åˆ¶**ï¼Œç”¨äº**ä½çº§å†…å­˜æ“ä½œ**ï¼Œå¦‚ï¼š

â€‹	â€¢	**ä»»æ„ç±»å‹çš„æŒ‡é’ˆè½¬æ¢**ï¼ˆ*T1 â†” *T2ï¼‰

â€‹	â€¢	**æŒ‡é’ˆä¸ uintptr ç›¸äº’è½¬æ¢**ï¼Œå®ç°**æŒ‡é’ˆè¿ç®—**

â€‹	â€¢	**è®¿é—®éå¯¼å‡ºå­—æ®µ**

â€‹	â€¢	**ä¸ C ä»£ç è¿›è¡Œäº¤äº’**



## æ»¥ç”¨å¯¼è‡´çš„GCç ´å

**1ï¸âƒ£ Go GCï¼ˆåƒåœ¾å›æ”¶ï¼‰å¦‚ä½•å¤„ç†æŒ‡é’ˆ**

Go çš„åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æ˜¯**åŸºäºå¯è¾¾æ€§åˆ†æ**çš„ï¼š

â€‹	â€¢	GC éå†æ‰€æœ‰ **æ ¹å¯¹è±¡**ï¼ˆå¦‚å…¨å±€å˜é‡ã€æ ˆä¸Šçš„æŒ‡é’ˆç­‰ï¼‰ã€‚

â€‹	â€¢	é€šè¿‡æŒ‡é’ˆå¼•ç”¨æ‰¾åˆ°**ä»ç„¶å¯è¾¾çš„å¯¹è±¡**ï¼Œå°†å…¶æ ‡è®°ä¸ºå­˜æ´»ã€‚

â€‹	â€¢	ä¸å¯è¾¾çš„å¯¹è±¡ä¼šè¢«å›æ”¶ã€‚

å¦‚æœ GC å‘ç°æŸä¸ªå†…å­˜åœ°å€**æ²¡æœ‰ä»»ä½•æŒ‡é’ˆå¼•ç”¨**ï¼Œå®ƒå¯èƒ½ä¼šè®¤ä¸ºè¯¥å¯¹è±¡å·²ç»ä¸éœ€è¦äº†ï¼Œå¹¶è¿›è¡Œå›æ”¶ã€‚

**2ï¸âƒ£ unsafe.Pointer çš„ç‰¹æ®Šæ€§**

unsafe.Pointer æ˜¯ Go è¯­è¨€ä¸­çš„**é€šç”¨æŒ‡é’ˆç±»å‹**ï¼Œå¯ä»¥ä¸ä»»ä½•æŒ‡é’ˆç±»å‹ï¼ˆ*Tï¼‰äº’ç›¸è½¬æ¢ï¼š

```
var x int
ptr := unsafe.Pointer(&x) // *int â†’ unsafe.Pointer
```

å®ƒå…è®¸ç»•è¿‡ Go çš„ç±»å‹ç³»ç»Ÿè¿›è¡ŒæŒ‡é’ˆæ“ä½œï¼Œå› æ­¤åœ¨ä¸å°å¿ƒä½¿ç”¨æ—¶ï¼Œå¯èƒ½å¯¼è‡´ GC è¯¯åˆ¤å¯¹è±¡æ˜¯å¦ä»ç„¶å­˜æ´»ã€‚

 unsafe.Pointer ç ´å GC çš„ä¸¤ç§æƒ…å†µ**



**ğŸ”¹ 1. é€šè¿‡ uintptr è¿›è¡ŒæŒ‡é’ˆè¿ç®—ï¼Œå¯¼è‡´å¯¹è±¡æ‚¬ç©º**



Go çš„ GC åªè¿½è¸ª**æŒ‡é’ˆç±»å‹**ï¼ˆå¦‚ *intï¼‰ï¼Œä½† uintptr æ˜¯ä¸€ä¸ªæ™®é€šæ•´æ•°ï¼Œä¸ä¼šè¢« GC è§†ä¸ºæŒ‡é’ˆã€‚å› æ­¤ï¼Œå¦‚æœæŠŠ unsafe.Pointer è½¬æ¢ä¸º uintptrï¼ŒGC å¯èƒ½é”™è¯¯åœ°è®¤ä¸ºåŸå¯¹è±¡å·²ç»ä¸å¯è¾¾ï¼Œå¹¶å›æ”¶å®ƒã€‚



**âŒ é”™è¯¯ç¤ºä¾‹**

```
package main

import (
	"fmt"
	"unsafe"
)

func main() {
	data := []int{1, 2, 3}
	ptr := uintptr(unsafe.Pointer(&data[0])) // unsafe.Pointer â†’ uintptr
	// æ­¤æ—¶ï¼ŒGo GC å¯èƒ½å›æ”¶ `data`ï¼Œå› ä¸º `ptr` åªæ˜¯ä¸ªæ•´æ•°ï¼ŒGC ä¸çŸ¥é“å®ƒæ˜¯æŒ‡é’ˆ
	fmt.Println(*(*int)(unsafe.Pointer(ptr))) // æ‚¬ç©ºæŒ‡é’ˆï¼Œå¯èƒ½å¯¼è‡´å´©æºƒï¼
}
```

**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**

ä¸è¦å­˜å‚¨ uintptrï¼Œè€Œæ˜¯ä¿æŒ unsafe.Pointerï¼Œè®© GC èƒ½è¿½è¸ªï¼š

```
ptr := unsafe.Pointer(&data[0]) // è¿™æ · GC ä»ç„¶çŸ¥é“ data çš„å­˜åœ¨
```

**ğŸ”¹ 2. é€šè¿‡ unsafe.Pointer ä¿®æ”¹ Go å¯¹è±¡ï¼Œä½¿ GC å¤±æ•ˆ**



GC ä¾èµ–ç±»å‹ä¿¡æ¯æ¥æ­£ç¡®å›æ”¶å†…å­˜ã€‚å¦‚æœä½¿ç”¨ unsafe.Pointer è¯¯ä¿®æ”¹äº† Go è¿è¡Œæ—¶çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œå¯èƒ½ä¼šå¯¼è‡´ GC å¤±æ•ˆã€‚



**âŒ é”™è¯¯ç¤ºä¾‹**

```
package main

import (
	"fmt"
	"unsafe"
)

func main() {
	str := "hello"
	strHeader := (*[2]uintptr)(unsafe.Pointer(&str)) // ä¿®æ”¹å­—ç¬¦ä¸²ç»“æ„ä½“
	strHeader[1] = 1000                              // éæ³•ä¿®æ”¹é•¿åº¦å­—æ®µ
	fmt.Println(str)                                 // å´©æºƒæˆ–æœªå®šä¹‰è¡Œä¸º
}
```

â€‹	â€¢	Go **å­—ç¬¦ä¸²æ˜¯ä¸å¯å˜çš„**ï¼Œä½†è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä¿®æ”¹äº†åº•å±‚ç»“æ„ï¼Œç ´åäº† GC è§„åˆ™ï¼Œå¯èƒ½å¯¼è‡´å´©æºƒã€‚



**ğŸ’¡ è§£å†³æ–¹æ¡ˆ**

ä¸è¦ç”¨ unsafe.Pointer ç›´æ¥ä¿®æ”¹ Go è¿è¡Œæ—¶ç®¡ç†çš„å¯¹è±¡ï¼Œå°¤å…¶æ˜¯å­—ç¬¦ä¸²ã€åˆ‡ç‰‡ã€æ˜ å°„ç­‰å¤æ‚ç»“æ„ã€‚

- **unsafe.Pointer å®‰å…¨ä½¿ç”¨åŸåˆ™**

| **å®‰å…¨æ€§** | **åŸåˆ™**                                         |
| ---------- | ------------------------------------------------ |
| âœ… **å…è®¸** | ç”¨äºè½¬æ¢ä¸åŒæŒ‡é’ˆç±»å‹ï¼Œä¾‹å¦‚ *T â†” unsafe.Pointer   |
| âœ… **å…è®¸** | è®¡ç®—ç»“æ„ä½“å­—æ®µåç§»ï¼Œå¦‚ unsafe.Offsetof           |
| âŒ **é¿å…** | ä½¿ç”¨ uintptr è¿›è¡ŒæŒ‡é’ˆè¿ç®—å¹¶å­˜å‚¨ï¼ˆGC æ— æ³•è¿½è¸ªï¼‰   |
| âŒ **é¿å…** | ä¿®æ”¹ Go è¿è¡Œæ—¶çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼ˆå¦‚ stringã€sliceï¼‰ |
| âŒ **é¿å…** | ç›´æ¥è®¿é—®å’Œæ“ä½œ Go çš„å†…å­˜ç®¡ç†åŒºåŸŸ                 |



* **æ€»ç»“**



1ï¸âƒ£ Go çš„ GC é€šè¿‡**æŒ‡é’ˆå¯è¾¾æ€§**ç®¡ç†å†…å­˜ï¼Œunsafe.Pointer å¯èƒ½ç»•è¿‡ç±»å‹ç³»ç»Ÿï¼Œå½±å“ GC åˆ¤æ–­ã€‚

2ï¸âƒ£ **å°† unsafe.Pointer è½¬æ¢ä¸º uintptr** å¯èƒ½å¯¼è‡´ GC è¯¯å›æ”¶å¯¹è±¡ï¼Œé€ æˆæ‚¬ç©ºæŒ‡é’ˆã€‚

3ï¸âƒ£ ä½¿ç”¨ unsafe.Pointer **ä¿®æ”¹ Go è¿è¡Œæ—¶çš„å†…éƒ¨æ•°æ®ç»“æ„**ï¼ˆå¦‚ stringã€sliceï¼‰å¯èƒ½ç ´å GC å’Œè¿è¡Œæ—¶ï¼Œå¯¼è‡´æœªå®šä¹‰è¡Œä¸ºã€‚

4ï¸âƒ£ **å®‰å…¨ä½¿ç”¨ unsafe.Pointerï¼š** åªç”¨äºç±»å‹è½¬æ¢ï¼Œé¿å… uintptr å­˜å‚¨å’ŒæŒ‡é’ˆè¿ç®—ã€‚





## new ä¸makeçš„åŒºåˆ«

- make ä»…ç”¨æ¥åˆ†é…åŠ**åˆå§‹åŒ–**ç±»å‹ä¸º **sliceã€mapã€chan** çš„æ•°æ®

- new å¯åˆ†é…ä»»æ„ç±»å‹çš„æ•°æ®ï¼Œæ ¹æ®ä¼ å…¥çš„ç±»å‹ç”³è¯·ä¸€å—å†…å­˜ï¼Œè¿”å›æŒ‡å‘è¿™å—å†…å­˜çš„æŒ‡é’ˆï¼Œå³ç±»å‹ *Typeã€‚**ä¸åˆå§‹åŒ–**





## å†…å­˜æ³„æ¼





## C++ç©ºå¯¹è±¡/ç±»å¤§å°ï¼Œä¸ºä»€ä¹ˆï¼Ÿ â€”â€” å¯¹æ¯”goçš„`struct{}`

**ç©ºç±»å 1ä¸ªå­—èŠ‚**ï¼ˆç±»å’Œå¯¹è±¡å¤§å°é€šå¸¸ç›¸ç­‰ï¼‰

åŸå› ï¼š

- ä¿è¯æ¯ä¸ªå¯¹è±¡æœ‰å”¯ä¸€çš„åœ°å€ï¼Œ
- ä¿è¯å†…å­˜å¸ƒå±€åˆç†ï¼Œæ¯”å¦‚å¯¹è±¡æ•°ç»„

> [!NOTE]
>
> **ç‰¹æ®Šæƒ…å†µï¼šç»§æ‰¿å¯èƒ½å¯¼è‡´ç©ºç±»å  0 å­—èŠ‚**
>
> - ç©ºåŸºç±»ä¼˜åŒ–â€”â€”ã€‰<u>C++ å…è®¸ç©ºåŸºç±»åœ¨å­ç±»ä¸­ä¸é¢å¤–å æ®ç©ºé—´ï¼Œé¿å…æµªè´¹å†…å­˜ã€‚</u>
>
>   ```cpp
>   #include <iostream>
>                                   
>   class Empty {};
>   class Derived : public Empty {};
>                                   
>   int main() {
>       std::cout << "Size of Derived: " << sizeof(Derived) << " bytes" << std::endl;   //Size of Derived: 1 bytes
>       return 0;
>   }
>   ```
>
>   



### ä¸ºä»€ä¹ˆgoçš„ç©ºç»“æ„ä½“å¤§å°ä¸º0

è®¾è®¡ç†å¿µä¸åŒï¼šGo è®¾è®¡ struct{} çš„åˆè¡·æ˜¯**é«˜æ•ˆã€ç®€æ´**ï¼Œå¦‚æœç»“æ„ä½“ä¸åŒ…å«ä»»ä½•å­—æ®µï¼Œå®ƒ**ä¸åº”è¯¥æµªè´¹ä»»ä½•å†…å­˜**ã€‚è¿™ä¸ C++ çš„è®¾è®¡ä¸åŒï¼ŒC++ å¼ºåˆ¶**å¯¹è±¡å¿…é¡»æœ‰å”¯ä¸€çš„åœ°å€**ï¼Œè€Œ Go ä¸è¦æ±‚è¿™ä¸€ç‚¹ã€‚

- ç©ºç»“æ„ä½“ç”¨é€”ï¼šï¼ˆèŠ‚çœç©ºé—´ï¼‰
  - map-ã€‹set
  - åœ¨channelä¸­ä¼ é€’ä¿¡å·ï¼Œä¸ä¼ è¾“å€¼





# è®¾è®¡æ¨¡å¼

## åˆ›å»ºå‹æ¨¡å¼

### å·¥å‚æ¨¡å¼

å®šä¹‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œç”±å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç±»

<img src="https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20250215%E4%B8%8B%E5%8D%8883412837.png" alt="image-20250215ä¸‹åˆ83412837" style="zoom:50%;" />

```go
package factory

type Product interface {
    Operation() string
}

type ProductA struct {}
func (p *ProductA) Operation() string {
    return "ProductA"
}

type ProductB struct {}
func (p *ProductA) Operation() string {
    return "ProductB"
}

type Factory interface {
    CreateProduct() Product
}

type ConcreteFactoryA struct {}
func (c *ConcreteFactoryA) CreateProduct() Product {
    return &ProductA{}
}

type ConcreteFactoryB struct {}
func (c *ConcreteFactoryA) CreateProduct() Product {
    return &ProductB{}
}

func main() {
  var factoryA Factory
  factoryA = new(ConcreteFactoryA)
  
  var product Product
  product = facotryA.CreateProduct()
  product.Operation()
}
```



### å•ä¾‹æ¨¡å¼

é¥¿æ±‰ï¼š

```go
package singleton

type singleton struct {}

var instance = &singleton{}

func GetInstance() *singleton {
    return instance
}
```



æ‡’æ±‰ï¼š

```go
//åŒæ£€æŸ¥é”
package singleton

import "sync"

type singleton struct {}

var (
    instance *singleton
    mu       sync.Mutex
)

// ä¼ ç»ŸåŒé‡æ£€æŸ¥é”å®ç°
func GetInstance() *singleton {
    if instance == nil { // ç¬¬ä¸€æ¬¡æ£€æŸ¥
        mu.Lock()
        defer mu.Unlock()
        
        if instance == nil { // ç¬¬äºŒæ¬¡æ£€æŸ¥
            instance = &singleton{}
        }
    }
    return instance
}


//sync.Once
package singleton

import "sync"

type singleton struct {}

var once sync.Once
var instance *singleton


func GetInstance() *singleton {
    once.Do(func() {
        instance = &singleton{}
    })
    return instance
}
```



## ç»“æ„å‹æ¨¡å¼

### ä»£ç†æ¨¡å¼

```go
package proxy

import "fmt"

type RealSubject interface {
    Request()
}

type RealSubjectImpl struct {}

func (r *RealSubjectImpl) Request() {
    fmt.Println("RealSubject: Handling request")
}

type Proxy struct {
    realSubject RealSubject
}

func (p *Proxy) Request() {
    fmt.Println("Proxy: Logging request")
    if p.realSubject == nil {
        p.realSubject = &RealSubjectImpl{}
    }
    p.realSubject.Request()
}
```

### è£…é¥°å™¨æ¨¡å¼

é€šè¿‡å°†åŠŸèƒ½åŠ¨æ€åœ°é™„åŠ åˆ°å¯¹è±¡ä¸Šï¼Œæ¥æ‰©å±•å¯¹è±¡çš„åŠŸèƒ½ï¼Œè€Œä¸æ”¹å˜å¯¹è±¡æœ¬èº«çš„ç»“æ„

```go
package main

import "fmt"

// Component æ¥å£ï¼Œå®šä¹‰äº†åŸºæœ¬è¡Œä¸º
type Coffee interface {
    Cost() int
}

// SimpleCoffee å…·ä½“ç»„ä»¶ï¼Œå®ç°äº† Coffee æ¥å£
type SimpleCoffee struct {}

func (c *SimpleCoffee) Cost() int {
    return 5 // åŸºç¡€å’–å•¡çš„ä»·æ ¼
}

// Decorator è£…é¥°å™¨ï¼ŒåŒ…å«å¯¹ Component çš„å¼•ç”¨
type CoffeeDecorator struct {
    coffee Coffee
}

func (d *CoffeeDecorator) Cost() int {
    return d.coffee.Cost() // ç»§æ‰¿è‡ª Coffee çš„ Cost æ–¹æ³•
}

// MilkDecorator å…·ä½“è£…é¥°å™¨ï¼Œä¸º Coffee å¢åŠ ç‰›å¥¶
type MilkDecorator struct {
    CoffeeDecorator
}

func (m *MilkDecorator) Cost() int {
    return m.coffee.Cost() + 2 // æ·»åŠ ç‰›å¥¶çš„è´¹ç”¨
}

// SugarDecorator å…·ä½“è£…é¥°å™¨ï¼Œä¸º Coffee å¢åŠ ç³–
type SugarDecorator struct {
    CoffeeDecorator
}

func (s *SugarDecorator) Cost() int {
    return s.coffee.Cost() + 1 // æ·»åŠ ç³–çš„è´¹ç”¨
}

func main() {
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„å’–å•¡
    coffee := &SimpleCoffee{}
    fmt.Println("Simple Coffee Cost:", coffee.Cost())

    // ä½¿ç”¨ MilkDecorator å’Œ SugarDecorator è£…é¥°å’–å•¡
    milkCoffee := &MilkDecorator{CoffeeDecorator{coffee}}
    fmt.Println("Milk Coffee Cost:", milkCoffee.Cost())

    sugarMilkCoffee := &SugarDecorator{CoffeeDecorator{milkCoffee}}
    fmt.Println("Milk and Sugar Coffee Cost:", sugarMilkCoffee.Cost())
}
```

### é€‚é…å™¨æ¨¡å¼

å°†ä¸€ä¸ªç±»çš„æ¥å£è½¬æ¢æˆå®¢æˆ·ç«¯æ‰€æœŸæœ›çš„å¦ä¸€ä¸ªæ¥å£ï¼Œä»è€Œä½¿åŸæœ¬ç”±äºæ¥å£ä¸åŒ¹é…è€Œæ— æ³•ä¸€èµ·å·¥ä½œçš„ç±»èƒ½å¤ŸååŒå·¥ä½œã€‚

```go
package main

import "fmt"

// ç›®æ ‡æ¥å£ï¼šæ–°çš„ç³»ç»Ÿéœ€è¦çš„æ¥å£
type Sensor interface {
    ReadData() float64
}

// é€‚é…è€…ï¼šæ—§çš„ç³»ç»Ÿæ¥å£ï¼Œæ— æ³•ç›´æ¥ä½¿ç”¨
type OldSystem struct {}

func (o *OldSystem) GetTemperature() float64 {
    return 25.5 // æ¨¡æ‹Ÿè¿”å›æ¸©åº¦å€¼
}

// é€‚é…å™¨ï¼šå°† OldSystem çš„æ¥å£é€‚é…æˆ Sensor æ¥å£
type SensorAdapter struct {
    oldSystem *OldSystem
}

func (a *SensorAdapter) ReadData() float64 {
    // è°ƒç”¨æ—§ç³»ç»Ÿçš„ GetTemperature æ–¹æ³•
    return a.oldSystem.GetTemperature()
}

func main() {
    // åˆ›å»ºæ—§ç³»ç»Ÿå®ä¾‹
    oldSystem := &OldSystem{}
    
    // ä½¿ç”¨é€‚é…å™¨å°†æ—§ç³»ç»Ÿé€‚é…æˆæ–°çš„æ¥å£
    sensor := &SensorAdapter{oldSystem: oldSystem}

    // ä½¿ç”¨æ–°çš„æ¥å£è°ƒç”¨
    fmt.Printf("Temperature: %.2f\n", sensor.ReadData())
}
```



## è¡Œä¸ºå‹æ¨¡å¼

### ç­–ç•¥æ¨¡å¼

å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œå°†æ¯ä¸€ä¸ªç®—æ³•å°è£…èµ·æ¥ï¼Œå¹¶ä½¿å®ƒä»¬å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚

```go
package strategy

import "fmt"

type Strategy interface {
    Execute(a, b int) int
}

type AddStrategy struct {}
func (s *AddStrategy) Execute(a, b int) int {
    return a + b
}

type SubtractStrategy struct {}
func (s *SubtractStrategy) Execute(a, b int) int {
    return a - b
}

type Context struct {
    strategy Strategy
}

func (c *Context) SetStrategy(strategy Strategy) {
    c.strategy = strategy
}

func (c *Context) ExecuteStrategy(a, b int) int {
    return c.strategy.Execute(a, b)
}
```



### è§‚å¯Ÿè€…æ¨¡å¼

å…è®¸å¯¹è±¡åœ¨å…¶çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥ä¾èµ–å®ƒçš„æ‰€æœ‰å¯¹è±¡

```go
package observer

import "fmt"

type Observer interface {
    Update(message string)
}

type ConcreteObserver struct {
    name string
}

func (o *ConcreteObserver) Update(message string) {
    fmt.Printf("%s received message: %s\n", o.name, message)
}

type Subject interface {
    Attach(observer Observer)
    Detach(observer Observer)
    Notify(message string)
}

type ConcreteSubject struct {
    observers []Observer
}

func (s *ConcreteSubject) Attach(observer Observer) {
    s.observers = append(s.observers, observer)
}

func (s *ConcreteSubject) Detach(observer Observer) {
    for i, o := range s.observers {
        if o == observer {
            s.observers = append(s.observers[:i], s.observers[i+1:]...)
            break
        }
    }
}

func (s *ConcreteSubject) Notify(message string) {
    for _, observer := range s.observers {
        observer.Update(message)
    }
}
```



# GIN

```go
package main

import "github.com/gin-gonic/gin"

func main() {
	r := gin.Default()
	r.GET("/ping", func(c *gin.Context) {
		c.JSON(200, gin.H{
			"message": "pong",
		})
	})
	r.Run() // ç›‘å¬å¹¶åœ¨ 0.0.0.0:8080 ä¸Šå¯åŠ¨æœåŠ¡
}
```



## bind

ç»‘å®šä¼ å…¥å‚æ•°ï¼Œå¯¹å‚æ•°è¿›è¡Œç±»å‹æ ¡éªŒï¼ˆ[å¯è‡ªå®šä¹‰éªŒè¯å™¨](https://docs.fengfengzhidao.com/#/docs/Gin%E6%A1%86%E6%9E%B6%E6%96%87%E6%A1%A3/4.bind%E7%BB%91%E5%AE%9A%E5%99%A8)ï¼‰

- `ShouldBind`ï¼š`ShouldBindJSON`ã€`ShouldBindQuery`ã€`ShouldBindUri`...

###  éªŒè¯å™¨

```go
type UserInfo struct {
  Username string `json:"username" binding:"required" msg:"ç”¨æˆ·åä¸èƒ½ä¸ºç©º"`
  Password string `json:"password" binding:"min=3,max=6" msg:"å¯†ç é•¿åº¦ä¸èƒ½å°äº3å¤§äº6"`
  Email    string `json:"email" binding:"email" msg:"é‚®ç®±åœ°å€æ ¼å¼ä¸æ­£ç¡®"`
}

```

- å¸¸ç”¨æ ¡éªŒå™¨

```go
// ä¸èƒ½ä¸ºç©ºï¼Œå¹¶ä¸”ä¸èƒ½æ²¡æœ‰è¿™ä¸ªå­—æ®µ
requiredï¼š å¿…å¡«å­—æ®µï¼Œå¦‚ï¼šbinding:"required"  

// é’ˆå¯¹å­—ç¬¦ä¸²çš„é•¿åº¦
min æœ€å°é•¿åº¦ï¼Œå¦‚ï¼šbinding:"min=5"
max æœ€å¤§é•¿åº¦ï¼Œå¦‚ï¼šbinding:"max=10"
len é•¿åº¦ï¼Œå¦‚ï¼šbinding:"len=6"

// é’ˆå¯¹æ•°å­—çš„å¤§å°
eq ç­‰äºï¼Œå¦‚ï¼šbinding:"eq=3"
ne ä¸ç­‰äºï¼Œå¦‚ï¼šbinding:"ne=12"
gt å¤§äºï¼Œå¦‚ï¼šbinding:"gt=10"
gte å¤§äºç­‰äºï¼Œå¦‚ï¼šbinding:"gte=10"
lt å°äºï¼Œå¦‚ï¼šbinding:"lt=10"
lte å°äºç­‰äºï¼Œå¦‚ï¼šbinding:"lte=10"

// é’ˆå¯¹åŒçº§å­—æ®µçš„
eqfield ç­‰äºå…¶ä»–å­—æ®µçš„å€¼ï¼Œå¦‚ï¼šPassWord string `binding:"eqfield=Password"`
nefield ä¸ç­‰äºå…¶ä»–å­—æ®µçš„å€¼


- å¿½ç•¥å­—æ®µï¼Œå¦‚ï¼šbinding:"-"

```







## æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½

- ä¸Šä¼ 

```go
func main() {
	router := gin.Default()
	// ä¸º multipart forms è®¾ç½®è¾ƒä½çš„å†…å­˜é™åˆ¶ (é»˜è®¤æ˜¯ 32 MiB)
	router.MaxMultipartMemory = 8 << 20  // 8 MiB
	router.POST("/upload", func(c *gin.Context) {
		// å•æ–‡ä»¶
		file, _ := c.FormFile("file")
		log.Println(file.Filename)

		dst := "./" + file.Filename
		// ä¸Šä¼ æ–‡ä»¶è‡³æŒ‡å®šçš„å®Œæ•´æ–‡ä»¶è·¯å¾„
		c.SaveUploadedFile(file, dst)

		c.String(http.StatusOK, fmt.Sprintf("'%s' uploaded!", file.Filename))
	})
	router.Run(":8080")
}
```

å¦‚ä½•ä½¿ç”¨ `curl`ï¼š

```sh
curl -X POST http://localhost:8080/upload \
  -F "file=@/Users/appleboy/test.zip" \
  -H "Content-Type: multipart/form-data"
```





## ä¸­é—´ä»¶å’Œè·¯ç”±                                 



# å…¶ä»–  

## Go/C++åŒºåˆ«

- æ ‡å‡†åº“å®¹å™¨

- ç¬¬ä¸‰æ–¹åº“ï¼ŒåŒ…ç®¡ç†

  - C++ï¼šâŒ æ— å®˜æ–¹å·¥å…·ï¼ˆéœ€ç”¨ vcpkg / Conanï¼‰ä¾èµ– CMake å’Œç¬¬ä¸‰æ–¹å·¥å…·
  - Golangï¼šâœ… Go Modules å®˜æ–¹æ”¯æŒ

- å¹¶å‘æ¨¡å‹

- ç±»å‹ç³»ç»Ÿ

  - C++æ”¯æŒéšå¼ç±»å‹è½¬æ¢
  - Golangç¦æ­¢éšå¼ç±»å‹è½¬æ¢

- å®ç°å¤šæ€çš„æ–¹å¼

  - C++ çš„å¤šæ€ä¸»è¦é€šè¿‡ **è™šå‡½æ•°ï¼ˆvirtual functionï¼‰** å’Œ **è¿è¡Œæ—¶å¤šæ€ï¼ˆRuntime Polymorphismï¼‰** å®ç°ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ **æ¨¡æ¿ï¼ˆTemplatesï¼‰** å®ç° **ç¼–è¯‘æ—¶å¤šæ€ï¼ˆCompile-time Polymorphismï¼‰**ã€‚

  - Go **ä¸æ”¯æŒç±»ç»§æ‰¿**ï¼Œä½†æ”¯æŒ**æ¥å£ï¼ˆinterfaceï¼‰ï¼ˆé¸­å­ç±»å‹ï¼‰**æ¥å®ç°å¤šæ€ã€‚

    ```go
    package main
    
    import "fmt"
    
    // å®šä¹‰æ¥å£
    type Animal interface {
        MakeSound()
    }
    
    // Dog ç»“æ„ä½“å®ç° Animal æ¥å£
    type Dog struct{}
    func (d Dog) MakeSound() {
        fmt.Println("Dog barks")
    }
    
    // Cat ç»“æ„ä½“å®ç° Animal æ¥å£
    type Cat struct{}
    func (c Cat) MakeSound() {
        fmt.Println("Cat meows")
    }
    
    func main() {
        var animal Animal
    
        animal = Dog{}
        animal.MakeSound() // âœ… Dog barks
    
        animal = Cat{}
        animal.MakeSound() // âœ… Cat meows
    }
    ```

    

- åº”ç”¨åœºæ™¯ï¼š

  - C++ï¼šäº¤æ˜“ç³»ç»Ÿã€æ¸¸æˆå¼•æ“ã€åµŒå…¥å¼
  - Golangï¼šäº‘åŸç”Ÿã€å¾®æœåŠ¡ã€åˆ†å¸ƒå¼






## Goä¸­å˜é‡çš„åˆå§‹åŒ–é¡ºåºï¼ˆå…¨å±€/`init()`/ï¼‰

1. é€’å½’åŒ…å†…çš„å˜é‡/init()
2. è¯¥åŒ…çš„å…¨å±€å˜é‡
3. è¯¥åŒ…çš„init()



```go
// mypkg/mypkg.go
package mypkg

import "fmt"

var X = initializeX()

func initializeX() int {
	fmt.Println("Initializing X in mypkg")
	return 42
}

func init() {
	fmt.Println("Executing init() in mypkg")
}
/////////////////////////

package main

import (
	"fmt"
	_ "mypkg" // åªè§¦å‘ mypkg çš„åˆå§‹åŒ–ï¼Œä¸ä½¿ç”¨å…¶æ ‡è¯†ç¬¦
)

func init() {
	fmt.Println("Executing init() in main")
}

func main() {
	fmt.Println("Executing main()")
}
```

è¾“å‡ºï¼š

```bash
Initializing X in mypkg
Executing init() in mypkg
Executing init() in main
Executing main()
```

