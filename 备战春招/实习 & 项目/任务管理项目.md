# é¡¹ç›®ä»‹ç»

å¹²ä»€ä¹ˆï¼Ÿæ€Žä¹ˆåšï¼Ÿæ•ˆæžœï¼Ÿ

å®žä¹ éƒ¨é—¨ç»´æŠ¤è€é¡¹ç›®UF2.0è¯åˆ¸äº¤æ˜“ç³»ç»Ÿï¼Œéœ€è¦å®Œæˆè¡¥ä¸å•ï¼Œå¯¹åº”å¤šä¸ªéœ€æ±‚å•ï¼Œå¯¹åº”å¤šä¸ªä»»åŠ¡å•ï¼Œå…³ç³»å¤æ‚åˆ‡æ—¶é—´ç®¡ç†è¾ƒä¸ºå›°éš¾ï¼Œå¯¼è‡´ç®¡ç†å‘˜å’Œå‘˜å·¥æŸ¥çœ‹ç©ºé—²æ—¶é—´è¾ƒå›°éš¾ï¼Œè¿™ä¸ªé¡¹ç›®é€šè¿‡å…¬å¸æ•ˆèƒ½å¹³å°å¯¼å‡ºxmlæ–‡ä»¶ï¼Œå†å¯¼å…¥è¡¥ä¸åˆ°é¡¹ç›®ä¸­ï¼ˆè¡¥ä¸å¯¹åº”å¤šä¸ªéœ€æ±‚ï¼Œéœ€æ±‚å¯¹åº”å¤šä¸ªä»»åŠ¡å•ï¼‰ï¼Œå¯¹äºŽå‘˜å·¥æ¥è¯´åªéœ€è¦å…³ç³»ä»»åŠ¡å•ï¼Œå¹¶ä¸”å¯ä»¥ä¿®æ”¹ä»»åŠ¡å•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´æˆªæ­¢æ—¥æœŸï¼Œç›¸å…³ä¿®æ”¹ä¼šé€šè¿‡redisçš„å‘å¸ƒè®¢é˜…æ¨¡å¼é€šçŸ¥å…¶ä»–ç›¸å…³ç”¨æˆ·ï¼Œå¯¹äºŽç®¡ç†å‘˜æ¥è¯´èƒ½å¤Ÿæ¸…æ™°çš„çœ‹åˆ°åœ¨ä¸€ä¸ªæ—¶é—´çº¿ä¸Šæ¯ä¸ªå‘˜å·¥æ¯å¤©çš„å·¥ä½œåŽ‹åŠ›ä»¥åŠç©ºé—²æ—¶é—´ã€‚

å…¶ä»–åŠŸèƒ½ï¼šä½¿ç”¨fyneç¼–å†™å®¢æˆ·ç«¯ï¼Œå®šæ—¶å‘é€é‚®ä»¶ã€dockeréƒ¨ç½²ã€nginxè´Ÿè½½å‡è¡¡

# ç›¸å…³é—®é¢˜

## gRPCä¸ŽHTTPçš„åŒºåˆ«

1ï¸âƒ£**åè®®å±‚æ¬¡å’Œæ•°æ®æ ¼å¼**ï¼š

- **HTTP**ï¼šHTTPæ˜¯ä¸€ç§åº”ç”¨å±‚åè®®ï¼Œé€šå¸¸ç”¨äºŽWebæœåŠ¡ï¼Œé€šè¿‡è¯·æ±‚å’Œå“åº”ä¼ è¾“æ•°æ®ã€‚å¸¸è§çš„æ•°æ®æ ¼å¼æ˜¯JSONæˆ–XMLï¼Œæ˜“äºŽäººç±»è¯»å–å’Œè°ƒè¯•ã€‚
- **gRPC**ï¼šgRPCåŸºäºŽHTTP/2åè®®ï¼Œä½¿ç”¨Protobufï¼ˆProtocol Buffersï¼‰ä½œä¸ºæ•°æ®åºåˆ—åŒ–æ ¼å¼ã€‚Protobufæ˜¯ä¸€ç§äºŒè¿›åˆ¶æ ¼å¼ï¼Œæ¯”JSONæ›´ç´§å‡‘ã€æ›´é«˜æ•ˆï¼Œå°¤å…¶åœ¨ä¼ è¾“å¤§è§„æ¨¡æ•°æ®æ—¶ä¼˜åŠ¿æ˜Žæ˜¾ã€‚

2ï¸âƒ£ **æ€§èƒ½å’Œæ•ˆçŽ‡**ï¼š

- **HTTP**ï¼šç”±äºŽä½¿ç”¨äº†æ–‡æœ¬æ ¼å¼ï¼ˆå¦‚JSONï¼‰ï¼ŒHTTPè¯·æ±‚å’Œå“åº”çš„æ•°æ®é‡ç›¸å¯¹è¾ƒå¤§ï¼Œè§£æžé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ã€‚
- **gRPC**ï¼šgRPCåˆ©ç”¨äº†HTTP/2çš„å¤šè·¯å¤ç”¨ã€æµæŽ§åˆ¶ã€å¤´éƒ¨åŽ‹ç¼©ç­‰ç‰¹æ€§ï¼Œç»“åˆProtobufçš„é«˜æ•ˆæ•°æ®ç¼–ç ï¼Œåœ¨ç½‘ç»œå’Œå¤„ç†æ€§èƒ½ä¸Šéƒ½æœ‰æ˜Žæ˜¾ä¼˜åŠ¿ã€‚

**3ï¸âƒ£ æµå¼é€šä¿¡**ï¼š

- **HTTP**ï¼šæ ‡å‡†çš„HTTPæ˜¯åŸºäºŽè¯·æ±‚-å“åº”çš„æ¨¡åž‹ï¼Œä¸æ”¯æŒåŒå‘æµé€šä¿¡ã€‚WebSocketå¯ä»¥å®žçŽ°å®žæ—¶åŒå‘é€šä¿¡ï¼Œä½†ä¸æ˜¯HTTPæœ¬èº«çš„ç‰¹æ€§ã€‚
- **gRPC**ï¼šgRPCåŽŸç”Ÿæ”¯æŒåŒå‘æµå¼é€šä¿¡ï¼ˆåŒå‘æµã€æœåŠ¡å™¨æµã€å®¢æˆ·ç«¯æµï¼‰ï¼Œé€‚åˆéœ€è¦å®žæ—¶æ•°æ®äº¤æ¢çš„åœºæ™¯ã€‚

4ï¸âƒ£ **ç±»åž‹å®‰å…¨**ï¼š

- **HTTP**ï¼šä½¿ç”¨JSONæ—¶ï¼Œç”±äºŽæ²¡æœ‰ä¸¥æ ¼çš„ç±»åž‹å®šä¹‰ï¼Œå®¹æ˜“åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¹‹é—´äº§ç”Ÿç±»åž‹ä¸åŒ¹é…çš„é”™è¯¯ã€‚
- **gRPC**ï¼šgRPCä½¿ç”¨Protobufå®šä¹‰æœåŠ¡å’Œæ¶ˆæ¯çš„ç»“æž„ï¼Œæä¾›äº†å¼ºç±»åž‹çš„æŽ¥å£ï¼Œç¼–è¯‘æ—¶å³èƒ½å‘çŽ°æ•°æ®ç»“æž„ä¸åŒ¹é…çš„é—®é¢˜ã€‚

5ï¸âƒ£ **ç”Ÿæ€ç³»ç»Ÿå’Œå…¼å®¹æ€§**ï¼š

- **HTTP**ï¼šä½œä¸ºWebåº”ç”¨çš„åŸºç¡€åè®®ï¼ŒHTTPæœ‰ç€å¹¿æ³›çš„ç”Ÿæ€ç³»ç»Ÿæ”¯æŒå’Œå…¼å®¹æ€§ã€‚å‡ ä¹Žæ‰€æœ‰ç¼–ç¨‹è¯­è¨€å’Œå¹³å°éƒ½æ”¯æŒHTTPã€‚
- **gRPC**ï¼šgRPCæä¾›äº†è·¨è¯­è¨€æ”¯æŒï¼Œä½†åœ¨ä¸€äº›ç‰¹å®šåœºæ™¯ä¸‹ï¼ˆå¦‚æµè§ˆå™¨ç«¯ï¼‰ä¸å¦‚HTTPæ™®éã€‚æ­¤å¤–ï¼ŒgRPCå¯¹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½éœ€è¦ä¾èµ–Protobufå®šä¹‰æ–‡ä»¶ï¼Œè¿™å¯èƒ½å¢žåŠ å¤æ‚æ€§ã€‚

### gRPC geteway

å½“å®¢æˆ·ç«¯ä¸æ”¯æŒ gRPC åè®®æ—¶ï¼Œæˆ–è€…éœ€è¦å°† gRPC æœåŠ¡æš´éœ²ç»™ Web åº”ç”¨ç¨‹åºæ—¶ï¼Œéœ€è¦ä¸€ç§å°† RESTful API è½¬æ¢ä¸º gRPC çš„æ–¹å¼

**gRPC-Gateway å®žçŽ°**

gRPC-Gateway æ˜¯ä¸€ä¸ªèƒ½å¤Ÿ **å°† gRPC æœåŠ¡è½¬æ¢ä¸º RESTful API** çš„å·¥å…·ï¼Œå…è®¸ HTTP/JSON è¯·æ±‚è¢«è½¬æ¢æˆ gRPC è¯·æ±‚ï¼Œå¹¶è¿”å›ž gRPC å“åº”ç»™ HTTP å®¢æˆ·ç«¯ã€‚è¿™æ ·å¯ä»¥è®© gRPC æœåŠ¡å…¼å®¹ REST ç”Ÿæ€ã€‚

- go-zero gRPC gatewayï¼šhttps://go-zero.dev/docs/tutorials/gateway/grpc



### protubufä»‹ç»ã€ç”¨é€”ã€ä¸Žjsonçš„åŒºåˆ«

**1ï¸âƒ£ Protocol Buffersï¼ˆprotobufï¼‰ä»‹ç»**

Protocol Buffersï¼ˆç®€ç§° **protobuf**ï¼‰æ˜¯ Google å¼€å‘çš„ä¸€ç§**è·¨è¯­è¨€ã€è·¨å¹³å°çš„åºåˆ—åŒ–åè®®**ï¼Œç”¨äºŽç»“æž„åŒ–æ•°æ®çš„åºåˆ—åŒ–ï¼ˆç±»ä¼¼äºŽ XML æˆ– JSONï¼Œä½†æ›´åŠ é«˜æ•ˆï¼‰ã€‚protobuf ä½¿ç”¨ .proto æ–‡ä»¶å®šä¹‰æ•°æ®ç»“æž„ï¼Œå¹¶é€šè¿‡ç¼–è¯‘å™¨ protoc ç”Ÿæˆä»£ç ï¼Œæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€ï¼ˆå¦‚ C++, Go, Java, Python ç­‰ï¼‰ã€‚

**2ï¸âƒ£ protobuf çš„ç”¨é€”**

protobuf ä¸»è¦ç”¨äºŽé«˜æ•ˆçš„æ•°æ®äº¤æ¢å’Œå­˜å‚¨ï¼Œå¸¸è§ç”¨é€”åŒ…æ‹¬ï¼š

â€‹	â€¢	**è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰**ï¼šå¦‚ gRPC æ¡†æž¶ç”¨äºŽæœåŠ¡é—´é€šä¿¡ï¼Œprotobuf ä½œä¸ºæ•°æ®æ ¼å¼ã€‚

â€‹	â€¢	**æ•°æ®å­˜å‚¨å’Œé…ç½®**ï¼šå¯ç”¨äºŽæŒä¹…åŒ–å­˜å‚¨ç»“æž„åŒ–æ•°æ®ï¼Œå¦‚æ•°æ®åº“å­˜å‚¨æˆ–é…ç½®æ–‡ä»¶ã€‚

â€‹	â€¢	**è·¨è¯­è¨€æ•°æ®äº¤æ¢**ï¼šä¸åŒè¯­è¨€é—´çš„æ•°æ®ä¼ è¾“æ ¼å¼ï¼Œå¦‚ Go ä¸Ž C++ ä¹‹é—´çš„æ•°æ®ä¼ è¾“ã€‚

â€‹	â€¢	**ç§»åŠ¨ç«¯ä¸ŽåŽç«¯é€šä¿¡**ï¼šAndroidã€iOS ä¸ŽæœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®åŒæ­¥ã€‚

**3ï¸âƒ£ protobuf ä¸Ž JSON çš„åŒºåˆ«**

| **æ¯”è¾ƒé¡¹**   | **protobuf**                         | **JSON**                       |
| ------------ | ------------------------------------ | ------------------------------ |
| **æ•°æ®æ ¼å¼** | äºŒè¿›åˆ¶æ ¼å¼ï¼Œç´§å‡‘é«˜æ•ˆ                 | æ–‡æœ¬æ ¼å¼ï¼Œå¯è¯»æ€§å¥½ä½†å†—ä½™å¤§     |
| **ä½“ç§¯å¤§å°** | ä½“ç§¯å°ï¼Œé€‚åˆå¸¦å®½å—é™çš„åœºæ™¯           | ä½“ç§¯å¤§ï¼Œå ç”¨æ›´å¤šå­˜å‚¨å’Œä¼ è¾“å¸¦å®½ |
| **è§£æžé€Ÿåº¦** | è§£æžé€Ÿåº¦å¿«ï¼ˆåŸºäºŽäºŒè¿›åˆ¶ç»“æž„ï¼‰         | è§£æžé€Ÿåº¦è¾ƒæ…¢ï¼ˆåŸºäºŽæ–‡æœ¬è§£æžï¼‰   |
|              |                                      |                                |
| **è‡ªæè¿°æ€§** | ä¾èµ– .proto æ–‡ä»¶ï¼Œä¸åŒ…å«å­—æ®µåç§°     | è‡ªå¸¦å­—æ®µåç§°ï¼Œæ˜“è¯»ä½†å†—ä½™       |
| **æ‰©å±•æ€§**   | å‘åŽå…¼å®¹ï¼Œæ–°å¢žå­—æ®µä¸ä¼šå½±å“æ—§ç‰ˆæœ¬è§£æž | ä¹Ÿæ”¯æŒæ‰©å±•æ€§ï¼Œä½†è§£æžæ€§èƒ½å—é™   |
| **ä½¿ç”¨åœºæ™¯** | é«˜æ€§èƒ½ RPCã€åµŒå…¥å¼ã€ç§»åŠ¨ç«¯ç­‰         | é…ç½®æ–‡ä»¶ã€Web APIã€æ—¥å¿—å­˜å‚¨ç­‰  |

ðŸ“Œ **æ€»ç»“**ï¼š

å¦‚æžœ**è¿½æ±‚é«˜æ•ˆä¼ è¾“**ï¼ˆå¦‚ gRPCã€ç§»åŠ¨ç«¯ã€æœåŠ¡å™¨é—´é€šä¿¡ï¼‰ï¼Œprotobuf æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

å¦‚æžœ**å¼ºè°ƒå¯è¯»æ€§å’Œçµæ´»æ€§**ï¼ˆå¦‚å‰åŽç«¯ JSON APIï¼‰ï¼ŒJSON å¯èƒ½æ›´é€‚åˆã€‚

## ä»€ä¹ˆæ˜¯GORMï¼Œæœ‰ä»€ä¹ˆç”¨ï¼Œä¸Žç›´æŽ¥ä½¿ç”¨MySQLåº“çš„åŒºåˆ«

è®©æˆ‘è§£é‡Šä¸€ä¸‹ GORM (Go Object Relational Mapping):

**1ï¸âƒ£ GORM æ˜¯ä»€ä¹ˆ**

GORM æ˜¯ Go è¯­è¨€çš„ ORM (å¯¹è±¡å…³ç³»æ˜ å°„) åº“ï¼Œå®ƒå°†æ•°æ®åº“è¡¨å’Œ Go ç»“æž„ä½“å¯¹åº”èµ·æ¥ï¼Œç®€åŒ–æ•°æ®åº“æ“ä½œã€‚å¹¶ä¸”æ”¯æŒè‡ªåŠ¨è¿ç§»ã€é’©å­ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè®©å†™ä»£ç æ›´åŠ ç®€æ´é«˜æ•ˆ

**2ï¸âƒ£ GORM vs åŽŸç”Ÿ MySQL å¯¹æ¯”**

**åŽŸç”Ÿ MySQLï¼š**

```go
// ä½¿ç”¨åŽŸç”Ÿ MySQL 
db, err := sql.Open("mysql", "user:password@/dbname")

// æŸ¥è¯¢ç”¨æˆ·
rows, err := db.Query("SELECT id, name, email FROM users WHERE id = ?", 1)
var user struct {
    ID    int
    Name  string
    Email string
}
for rows.Next() {
    err := rows.Scan(&user.ID, &user.Name, &user.Email)
}
```

**ä½¿ç”¨ GORMï¼š**
```go
// ä½¿ç”¨ GORM
db, err := gorm.Open(mysql.Open("user:password@/dbname"))

// å®šä¹‰æ¨¡åž‹
type User struct {
    ID    uint
    Name  string
    Email string
}

// æŸ¥è¯¢ç”¨æˆ·
var user User
db.First(&user, 1) // æŸ¥è¯¢ id ä¸º 1 çš„ç”¨æˆ·
```

**3ï¸âƒ£ GORM ä¸»è¦ç‰¹æ€§**

1. **è‡ªåŠ¨è¿ç§»**ï¼š
```go
// è‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–°è¡¨ç»“æž„
db.AutoMigrate(&User{}, &Product{})
```

2. **å…³è”å…³ç³»**ï¼š
```go
type User struct {
    ID       uint
    Name     string
    Orders   []Order  // ä¸€å¯¹å¤šå…³ç³»
    Profile  Profile  // ä¸€å¯¹ä¸€å…³ç³»
}

// æŸ¥è¯¢åŒ…å«å…³è”æ•°æ®
db.Preload("Orders").First(&user)
```

3. **é’©å­æ–¹æ³•**ï¼š
```go
func (u *User) BeforeCreate(tx *gorm.DB) error {
    // åˆ›å»ºè®°å½•å‰çš„æ“ä½œ
    u.CreatedAt = time.Now()
    return nil
}
```

4. **äº‹åŠ¡å¤„ç†**ï¼š
```go
db.Transaction(func(tx *gorm.DB) error {
    // åœ¨äº‹åŠ¡ä¸­æ‰§è¡Œæ“ä½œ
    if err := tx.Create(&user).Error; err != nil {
        return err
    }
    return nil
})
```

**4ï¸âƒ£ GORM çš„ä¼˜åŠ¿**

1. **ä»£ç æ›´ç®€æ´**ï¼š
```go
// GORM çš„é“¾å¼æ“ä½œ
db.Where("name = ?", "å¼ ä¸‰").
   Where("age > ?", 20).
   Find(&users)

// åŽŸç”Ÿ SQL
rows, err := db.Query(`
    SELECT * FROM users 
    WHERE name = ? AND age > ?
`, "å¼ ä¸‰", 20)
```

2. **ç±»åž‹å®‰å…¨**ï¼š
```go
type TaskInfo struct {
    TaskID     string    `gorm:"column:task_id;primaryKey"`
    Deadline   time.Time `gorm:"column:deadline"`
    Principal  string    `gorm:"column:principal"`
}

// GORM ä¼šè‡ªåŠ¨å¤„ç†ç±»åž‹è½¬æ¢
var task TaskInfo
db.First(&task)
```

3. **åŠŸèƒ½ä¸°å¯Œ**ï¼š
```go
// è½¯åˆ é™¤
type User struct {
    gorm.Model  // åŒ…å« DeletedAt å­—æ®µ
    Name string
}

// åˆ†é¡µæŸ¥è¯¢
db.Limit(10).Offset(0).Find(&users)

// å¤æ‚æŸ¥è¯¢
db.Model(&User{}).
   Select("name, sum(age) as total_age").
   Group("name").
   Having("sum(age) > ?", 100).
   Find(&results)
```

5ï¸âƒ£ **å®žé™…åº”ç”¨åœºæ™¯**

ä»Žé¡¹ç›®ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼š
```go:models/models.go
type TaskInfo struct {
    TaskID             string    `gorm:"column:task_id;type:varchar(25);primaryKey;not null;comment:ä»»åŠ¡å•å·"`
    Comment            string    `gorm:"column:comment;type:varchar(1000);comment:ä»»åŠ¡æè¿°"`
    EmergencyLevel     int       `gorm:"column:emergency_level;default:0;comment:ç´§æ€¥ç¨‹åº¦"`
    Deadline           time.Time `gorm:"column:deadline;type:date;default:(date_format((now() + interval 3 day),_utf8mb4'%Y-%m-%d'));comment:æˆªæ­¢æ—¥æœŸ"`
    Principal          string    `gorm:"column:principal;type:varchar(20);not null;comment:è´Ÿè´£äºº"`
}
```

è¿™ç§æ–¹å¼æ¯”ç›´æŽ¥å†™ SQL æ›´å®¹æ˜“ç»´æŠ¤å’Œç†è§£ï¼ŒåŒæ—¶é€šè¿‡ tag å¯ä»¥è¯¦ç»†å®šä¹‰å­—æ®µå±žæ€§ã€‚

6ï¸âƒ£ **ä½¿ç”¨å»ºè®®**

1. ç®€å•æŸ¥è¯¢ç”¨ GORM
2. å¤æ‚æŸ¥è¯¢å¯ä»¥æ··ç”¨åŽŸç”Ÿ SQL
3. åˆ©ç”¨ GORM çš„æ¨¡åž‹å®šä¹‰å’ŒéªŒè¯åŠŸèƒ½
4. åˆç†ä½¿ç”¨é¢„åŠ è½½é¿å… N+1 æŸ¥è¯¢é—®é¢˜

GORM è®©æ•°æ®åº“æ“ä½œæ›´åŠ é¢å‘å¯¹è±¡ï¼Œæé«˜äº†å¼€å‘æ•ˆçŽ‡ï¼Œä½†ä¹Ÿéœ€è¦æ³¨æ„æ€§èƒ½å¼€é”€ã€‚åœ¨é€‰æ‹©ä½¿ç”¨æ—¶è¦æ ¹æ®å®žé™…éœ€æ±‚æƒè¡¡ã€‚

## å‘å¸ƒè®¢é˜…æ¨¡å¼å®žçŽ°

- æ²¡æœ‰è€ƒè™‘æŒä¹…æ€§ã€å¯é æ€§

å½“æœ‰å®¢æˆ·ç«¯å»ºç«‹è¿žæŽ¥æ—¶ï¼ŒæœåŠ¡ç«¯å»ºç«‹streamæµç”¨äºŽæœåŠ¡ç«¯æŽ¨é€ï¼Œè®¢é˜…redisçš„â€œupdateâ€é¢‘é“ï¼ŒèŽ·å–å‘å¸ƒchannelï¼Œä¹‹åŽå¾ªçŽ¯èŽ·å–å‘å¸ƒchannelçš„æ¶ˆæ¯ï¼Œå½“å®¢æˆ·ç«¯è°ƒç”¨æŸä¸€ä¸ªæ›´æ”¹ä»»åŠ¡çš„rpcåŽï¼Œä¼šå‘updateé¢‘é“å‘é€æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯å›žå‘å¸ƒç»™æ‰€æœ‰è®¢é˜…updateé¢‘é“çš„é€šé“ä¸­ï¼ŒæœåŠ¡ç«¯channelæ”¶åˆ°ä¹‹åŽå¯¹æ¶ˆæ¯è¿›è¡Œåˆ†å‘å¤„ç†ï¼Œåˆ¤æ–­æ˜¯å¦å°†è¯¥æ¶ˆæ¯é€šè¿‡streamå‘é€ç»™æœ¬æ¬¡é“¾æŽ¥çš„å®¢æˆ·ç«¯

### ç¦»çº¿æ¶ˆæ¯å¤„ç†

é€šè¿‡redisä¸­çš„listå­˜æ”¾ç¦»çº¿ç”¨æˆ·çš„æ¶ˆæ¯

```go
// Subscribe å¤šä¸ªå®¢æˆ·ç«¯è°ƒç”¨
func (ns *notificationServer) Subscribe(req *pb.SubscriptionRequest, stream pb.NotificationService_SubscribeServer) error {
	
  //...

	for msg := range ch {
		//...

		if from == req.ClientId {
			if _, ok := ns.clients[to]; !ok {
				ns.storeMessage(to, msg.Payload)
			}
			continue
		}
		//...
	}
  
  //...

}


// æ¶ˆæ¯æŒä¹…åŒ–å­˜å‚¨
func (ns *notificationServer) storeMessage(clientId, message string) {
	key := fmt.Sprintf("user:%s:messages", clientId)
	ns.rdb.RPush(ns.ctx, key, message)
	ns.rdb.Expire(ns.ctx, fmt.Sprintf(key, clientId), time.Hour*24)
}
```



### rediså®žçŽ°æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼

- [rabbitMQ](../RabbitMQ.md)

**1ï¸âƒ£ listå®žçŽ°**

LPUSH + BRPOP å®žçŽ°

> - å•æ¶ˆè´¹è€…
> - æ— æ³•ä¿è¯å¯é æ€§

2ï¸âƒ£**å‘å¸ƒè®¢é˜…å®žçŽ°**

![image-20240921203124380](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20240921203124380.png)

> ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–
>
> æ— æ³•ä¿è¯å¯é æ€§
>
> æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±ï¼ˆæ¶ˆè´¹è€…æ— æ³•æŽ¥æ”¶åˆ°ç¦»çº¿æ—¶çš„æ•°æ®ï¼‰

**3ï¸âƒ£[Streams](https://redis.io/docs/latest/commands/?group=stream)**

**æ”¯æŒæ¶ˆæ¯çš„æŒä¹…åŒ–ã€æ”¯æŒè‡ªåŠ¨ç”Ÿæˆå…¨å±€å”¯ä¸€ IDã€æ”¯æŒ ack ç¡®è®¤æ¶ˆæ¯çš„æ¨¡å¼ã€æ”¯æŒæ¶ˆè´¹ç»„æ¨¡å¼ç­‰ï¼Œè®©æ¶ˆæ¯é˜Ÿåˆ—æ›´åŠ çš„ç¨³å®šå’Œå¯é **

1. `XADD`ç”Ÿäº§

![image-20240921204204306](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20240921204204306.png)

2. `XREAD`æ¶ˆè´¹

é€šè¿‡`XREAD`çš„`$`è¯»å–ï¼Œå¯èƒ½ä¼šå‡ºçŽ°==æ¶ˆæ¯æ¼è¯»==çš„é—®é¢˜ï¼Œå› ä¸º`$`åªä¼šè¯»å–æœ€æ–°æ¶ˆæ¯

![image-20240921204701258](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20240921204701258.png)

3. `XGROUP`æ¶ˆè´¹è€…ç»„

![image-20240921205309401](https://typora-dusong.oss-cn-chengdu.aliyuncs.com/image-20240921205309401.png)

- `XGROUP CREATE`
- `XREADGROUP`

#### ä¸‰ç§æ–¹å¼çš„å¯¹æ¯”

| **ç‰¹æ€§**         | **List**            | **Pub/Sub**      | **Stream**             |
| :--------------- | :------------------ | :--------------- | :--------------------- |
| **æ¶ˆæ¯æŒä¹…åŒ–**   | âœ”ï¸ï¼ˆå¯é…ç½®ï¼‰         | âŒ                | âœ”ï¸                      |
| **æ¶ˆè´¹æ¨¡å¼**     | ç‚¹å¯¹ç‚¹ï¼ˆå•æ¶ˆè´¹è€…ï¼‰  | å¹¿æ’­ï¼ˆå¤šæ¶ˆè´¹è€…ï¼‰ | æ”¯æŒç‚¹å¯¹ç‚¹å’Œæ¶ˆè´¹è€…ç»„   |
| **é˜»å¡žæ”¯æŒ**     | âœ”ï¸ï¼ˆBRPOPï¼‰          | âœ”ï¸ï¼ˆSUBSCRIBEï¼‰   | âœ”ï¸ï¼ˆXREADé˜»å¡žï¼‰         |
| **æ¶ˆæ¯ç¡®è®¤**     | âŒ                   | âŒ                | âœ”ï¸ï¼ˆéœ€æ‰‹åŠ¨ACKï¼‰         |
| **åŽ†å²æ¶ˆæ¯å›žæº¯** | âœ”ï¸ï¼ˆé€šè¿‡LRANGEæŸ¥è¯¢ï¼‰ | âŒ                | âœ”ï¸ï¼ˆæŒ‰IDèŒƒå›´è¯»å–ï¼‰      |
| **é€‚ç”¨åœºæ™¯**     | ç®€å•ä»»åŠ¡é˜Ÿåˆ—        | å®žæ—¶å¹¿æ’­é€šçŸ¥     | é«˜å¯é ã€å¤æ‚æ¶ˆæ¯æµå¤„ç† |



### ä¸ºä»€ä¹ˆè¦ç”¨redisçš„å‘å¸ƒè®¢é˜…æ¨¡å¼è€Œä¸ç›´æŽ¥ä½¿ç”¨grpcçš„stream

- é™ä½Žäº†æœåŠ¡å™¨å†…å­˜åŽ‹åŠ›
- æ›´æ–¹ä¾¿çš„å®žçŽ°å¹¿æ’­æ¶ˆæ¯
- åˆ†å¸ƒå¼åœºæ™¯ä¸‹å¯ä»¥æŽ¥å—å¤šä¸ªæœåŠ¡ç«¯èŠ‚ç‚¹çš„æ¶ˆæ¯



### ä¸ºä»€ä¹ˆé€‰æ‹©redisçš„å‘å¸ƒè®¢é˜…æ¨¡å¼ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ

- ç®€å•ï¼Œè½»ä¾¿ï¼Œæ²¡æœ‰æ¶ˆæ¯æŒä¹…åŒ–å’Œå¯é æ€§çš„éœ€æ±‚ï¼Œåˆšå¥½èƒ½æ»¡è¶³é¡¹ç›®éœ€æ±‚ï¼ˆå®žæ—¶å¹¿æ’­é€šçŸ¥ï¼‰ï¼Œæ²¡å¿…è¦å¼•å…¥â€œé‡é‡â€çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä»Žè€Œå¢žåŠ ä»£ç å’Œæ•´ä¸ªæž¶æž„çš„å¤æ‚ç¨‹åº¦
- å¯¹ç¦»çº¿ç”¨æˆ·æ¶ˆæ¯åšäº†æŒä¹…åŒ–



## å®šæ—¶å‘é€æ€Žä¹ˆåšçš„

```go
package main

import (
    "github.com/robfig/cron/v3"
    "log"
)

func main() {
    // åˆ›å»ºå®šæ—¶ä»»åŠ¡ç®¡ç†å™¨
    c := cron.New()

    // æ·»åŠ å®šæ—¶ä»»åŠ¡
    c.AddFunc("0 9 * * *", func() {
        log.Println("æ‰§è¡Œ 9 ç‚¹çš„ä»»åŠ¡")
        queryAndSendEmail()
    })

    c.AddFunc("0 13 * * *", func() {
        log.Println("æ‰§è¡Œ 13 ç‚¹çš„ä»»åŠ¡")
        queryAndSendEmail()
    })

    // å¯åŠ¨å®šæ—¶ä»»åŠ¡
    c.Start()

    // ä¿æŒç¨‹åºè¿è¡Œ
    select {}
}


```



## nginxè´Ÿè½½å‡è¡¡ç®—æ³•

> ### ä¸€ã€Nginx åŽŸç”Ÿæ”¯æŒçš„ç®—æ³•
> #### 1. **è½®è¯¢ï¼ˆRound Robinï¼‰**  
>    - **é»˜è®¤ç®—æ³•**ï¼ŒæŒ‰é¡ºåºä¾æ¬¡åˆ†å‘è¯·æ±‚åˆ°åŽç«¯æœåŠ¡å™¨ã€‚  
>    - **é…ç½®ç¤ºä¾‹**ï¼š  
>      ```nginx
>      upstream backend {
>          server 192.168.1.1;
>          server 192.168.1.2;
>      }
>      ```
>
> #### 2. **åŠ æƒè½®è¯¢ï¼ˆWeighted Round Robinï¼‰**  
>    - é€šè¿‡ `weight` å‚æ•°ä¸ºä¸åŒæœåŠ¡å™¨åˆ†é…æƒé‡ï¼Œæƒé‡è¶Šé«˜æŽ¥æ”¶çš„è¯·æ±‚è¶Šå¤šã€‚  
>    - **é€‚ç”¨åœºæ™¯**ï¼šæœåŠ¡å™¨æ€§èƒ½ä¸å‡è¡¡ï¼ˆå¦‚ CPUã€å†…å­˜å·®å¼‚ï¼‰ã€‚  
>    - **é…ç½®ç¤ºä¾‹**ï¼š  
>      ```nginx
>      upstream backend {
>          server 192.168.1.1 weight=3;  # 3/5 çš„æµé‡
>          server 192.168.1.2 weight=2;  # 2/5 çš„æµé‡
>      }
>      ```
>
> #### 3. **IP å“ˆå¸Œï¼ˆIP Hashï¼‰**  
>    - æ ¹æ®å®¢æˆ·ç«¯ IP åœ°å€çš„å“ˆå¸Œå€¼å›ºå®šåˆ†å‘åˆ°åŒä¸€æœåŠ¡å™¨ï¼Œè§£å†³ä¼šè¯ï¼ˆSessionï¼‰ä¿æŒé—®é¢˜ã€‚  
>    - **æ³¨æ„**ï¼šæœåŠ¡å™¨æ•°é‡å˜åŒ–ä¼šå¯¼è‡´å“ˆå¸Œç»“æžœæ”¹å˜ï¼Œéœ€è°¨æ…Žæ‰©å®¹ã€‚  
>    - **é…ç½®ç¤ºä¾‹**ï¼š  
>      ```nginx
>      upstream backend {
>          ip_hash;
>          server 192.168.1.1;
>          server 192.168.1.2;
>      }
>      ```
>
> #### 4. **æœ€å°‘è¿žæŽ¥ï¼ˆLeast Connectionsï¼‰**  
>    - å°†è¯·æ±‚åˆ†å‘ç»™å½“å‰è¿žæŽ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼Œé€‚åˆå¤„ç†é•¿è¿žæŽ¥ï¼ˆå¦‚ WebSocketã€æ•°æ®åº“ï¼‰ã€‚  
>    - **é…ç½®ç¤ºä¾‹**ï¼š  
>      ```nginx
>      upstream backend {
>          least_conn;
>          server 192.168.1.1;
>          server 192.168.1.2;
>      }
>      ```
>
> #### 5. **åŠ æƒæœ€å°‘è¿žæŽ¥ï¼ˆWeighted Least Connectionsï¼‰**  
>    - ç»“åˆ `weight` å‚æ•°å’Œæœ€å°‘è¿žæŽ¥ç­–ç•¥ï¼Œä¼˜åŒ–æ€§èƒ½å·®å¼‚æœåŠ¡å™¨çš„è´Ÿè½½åˆ†é…ã€‚  
>    - **é…ç½®ç¤ºä¾‹**ï¼š  
>      ```nginx
>      upstream backend {
>          least_conn;
>          server 192.168.1.1 weight=3;
>          server 192.168.1.2 weight=2;
>      }
>      ```
>
> ---
>
> ### äºŒã€Nginx Plusï¼ˆå•†ä¸šç‰ˆï¼‰æ”¯æŒçš„æ‰©å±•ç®—æ³•
> #### 1. **æœ€çŸ­å“åº”æ—¶é—´ï¼ˆLeast Timeï¼‰**  
>    - ä¼˜å…ˆé€‰æ‹©å“åº”æ—¶é—´æœ€çŸ­çš„æœåŠ¡å™¨ï¼Œéœ€ç»“åˆ `header`ï¼ˆé¦–å­—èŠ‚æ—¶é—´ï¼‰æˆ– `last_byte`ï¼ˆå®Œæ•´å“åº”æ—¶é—´ï¼‰ã€‚  
>    - **é€‚ç”¨åœºæ™¯**ï¼šå¯¹å»¶è¿Ÿæ•æ„Ÿçš„åº”ç”¨ï¼ˆå¦‚å®žæ—¶ APIï¼‰ã€‚  
>    - **é…ç½®ç¤ºä¾‹**ï¼š  
>      ```nginx
>      upstream backend {
>          least_time header;
>          server 192.168.1.1;
>          server 192.168.1.2;
>      }
>      ```
>
> #### 2. **éšæœºç®—æ³•ï¼ˆRandomï¼‰**  
>    - éšæœºé€‰æ‹©ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå¯ç»“åˆ `weight` å‚æ•°å®žçŽ°åŠ æƒéšæœºã€‚  
>    - **é…ç½®ç¤ºä¾‹**ï¼š  
>      ```nginx
>      upstream backend {
>          random;
>          server 192.168.1.1 weight=2;
>          server 192.168.1.2 weight=1;
>      }
>      ```
>
> ---
>
> ### ä¸‰ã€ç¬¬ä¸‰æ–¹æ¨¡å—æ‰©å±•çš„ç®—æ³•
> #### 1.[ **ä¸€è‡´æ€§å“ˆå¸Œï¼ˆConsistent Hashingï¼‰**  ](../../Cloud Native/åˆ†å¸ƒå¼/05_ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•.md)
>    - é€šè¿‡ `ngx_http_upstream_consistent_hash` æ¨¡å—å®žçŽ°ï¼Œå‡å°‘èŠ‚ç‚¹å˜åŠ¨å¯¹ç¼“å­˜çš„å½±å“ã€‚  
>    - **é€‚ç”¨åœºæ™¯**ï¼šåˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ Redisã€Memcachedï¼‰ã€‚  
>    - **é…ç½®ç¤ºä¾‹**ï¼š  
>      ```nginx
>      upstream backend {
>          consistent_hash $request_uri;  # æŒ‰è¯·æ±‚ URI å“ˆå¸Œ
>          server 192.168.1.1;
>          server 192.168.1.2;
>      }
>      ```
>
> #### 2. **Fair ç®—æ³•ï¼ˆç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰**  
>    - æ ¹æ®æœåŠ¡å™¨å®žæ—¶è´Ÿè½½ï¼ˆè¿žæŽ¥æ•°ã€å“åº”æ—¶é—´ï¼‰åŠ¨æ€åˆ†é…è¯·æ±‚ï¼Œéœ€å®‰è£… `nginx-upstream-fair` æ¨¡å—ã€‚  
>    - **é…ç½®ç¤ºä¾‹**ï¼š  
>      ```nginx
>      upstream backend {
>          fair;
>          server 192.168.1.1;
>          server 192.168.1.2;
>      }
>      ```
>
> #### 3. **NTLM è´Ÿè½½å‡è¡¡ï¼ˆåŸºäºŽè¯·æ±‚å†…å®¹ï¼‰**  
>    - é€‚ç”¨äºŽ Microsoft NTLM è®¤è¯åœºæ™¯ï¼Œéœ€ä½¿ç”¨ `nginx-ntlm` æ¨¡å—ã€‚
>
> ---
>
> ### å››ã€é…ç½®å…³é”®å‚æ•°
> 1. **å¥åº·æ£€æŸ¥**ï¼š  
>    ```nginx
>    server 192.168.1.1 max_fails=3 fail_timeout=30s;  # å¤±è´¥ 3 æ¬¡åŽæš‚åœ 30 ç§’
>    ```
> 2. **å¤‡ä»½æœåŠ¡å™¨**ï¼š  
>    ```nginx
>    server 192.168.1.3 backup;  # ä»…åœ¨ä¸»æœåŠ¡å™¨ä¸å¯ç”¨æ—¶å¯ç”¨
>    ```
>
> ---
>
> ### äº”ã€ç®—æ³•é€‰æ‹©å»ºè®®
> | **åœºæ™¯**                   | **æŽ¨èç®—æ³•**             |
> | -------------------------- | ------------------------ |
> | ä¼šè¯ä¿æŒï¼ˆå¦‚ç™»å½•çŠ¶æ€ï¼‰     | IP Hash                  |
> | æœåŠ¡å™¨æ€§èƒ½å·®å¼‚å¤§           | Weighted Round Robin     |
> | é•¿è¿žæŽ¥æœåŠ¡ï¼ˆå¦‚ WebSocketï¼‰ | Least Connections        |
> | ä½Žå»¶è¿Ÿè¦æ±‚                 | Least Timeï¼ˆNginx Plusï¼‰ |
> | ç¼“å­˜ç³»ç»Ÿ                   | ä¸€è‡´æ€§å“ˆå¸Œï¼ˆç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰ |
>
> 
>

